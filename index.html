<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>九州熊本親子自駕遊</title>
    
    <!-- Google Fonts: Noto Sans TC -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- FontAwesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Tailwind Config for Custom Colors -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        kuma: {
                            black: '#1a1a1a', // 熊本熊黑
                            red: '#FF5252',   // 腮紅紅
                            white: '#ffffff',
                            gray: '#f3f4f6'
                        },
                        aso: {
                            green: '#66BB6A', // 阿蘇綠
                            brown: '#8D6E63', // 火山土
                            blue: '#42A5F5'   // 天空/航班
                        }
                    },
                    fontFamily: {
                        sans: ['Noto Sans TC', 'sans-serif'],
                    },
                    boxShadow: {
                        'up': '0 -4px 6px -1px rgba(0, 0, 0, 0.1)',
                        'card': '0 4px 15px rgba(0, 0, 0, 0.05)',
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>

    <!-- Custom CSS for specialized UI elements -->
    <style>
        body {
            background-color: #f0f2f5;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* Hide scrollbar for Chrome, Safari and Opera */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        /* Hide scrollbar for IE, Edge and Firefox */
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }

        /* Smooth iOS styling */
        input, select, textarea {
            font-size: 16px !important; /* Prevent zoom on iOS */
        }

        .glass-tab {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        /* Custom Header Curve */
        .header-curve {
            border-bottom-left-radius: 40px;
            border-bottom-right-radius: 40px;
        }

        /* Markdown-like simple styling for AI response */
        .ai-response ul {
            list-style-type: disc;
            padding-left: 1.2em;
            margin-top: 0.5em;
            margin-bottom: 0.5em;
        }
        .ai-response strong {
            color: #1a1a1a;
            font-weight: 700;
        }
    </style>
    
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <!-- Markdown Parser (marked) for AI responses -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body class="text-gray-800 font-sans antialiased">

    <div id="app" class="pb-20 min-h-screen relative">
        
        <!-- ================= HEADER SECTION ================= -->
        <header class="relative z-10">
            <!-- Settings Button -->
            <button @click="showSettingsModal = true" class="absolute top-4 right-4 z-30 w-10 h-10 bg-black/30 backdrop-blur-sm text-white rounded-full flex items-center justify-center hover:bg-black/50 transition-colors">
                <i class="fa-solid fa-gear"></i>
            </button>

            <!-- Banner Image Container -->
            <div class="relative h-[250px] w-full header-curve overflow-hidden shadow-lg">
                <img 
                    src="熊本雄阿蘇火山圖.jpg" 
                    onerror="this.src='https://images.unsplash.com/photo-1542051841857-5f90071e7989?q=80&w=1920&auto=format&fit=crop'"
                    alt="Aso Volcano Banner" 
                    class="w-full h-full object-cover"
                >
                <div class="absolute inset-0 bg-gradient-to-t from-black/40 to-transparent"></div>
                
                <!-- Title Overlay -->
                <div class="absolute bottom-16 left-6 text-white">
                    <h1 class="text-3xl font-bold tracking-wide drop-shadow-md">九州冒險</h1>
                    <p class="text-sm opacity-90 font-medium mt-1">熊本 • 阿蘇 • 別府 • 高千穗</p>
                </div>
            </div>

            <!-- Floating Tabs (Navigation) -->
            <div class="absolute bottom-4 right-4 flex space-x-3 z-20">
                <button 
                    v-for="tab in tabs" 
                    :key="tab.id"
                    @click="currentTab = tab.id"
                    :class="[
                        'flex flex-col items-center justify-center w-14 h-14 rounded-2xl shadow-lg transition-all transform active:scale-95',
                        currentTab === tab.id 
                            ? 'bg-kuma-red text-white scale-110' 
                            : 'glass-tab text-kuma-black'
                    ]"
                >
                    <i :class="tab.icon + ' text-xl mb-1'"></i>
                    <span class="text-[10px] font-bold">{{ tab.name }}</span>
                </button>
            </div>
        </header>

        <!-- ================= MAIN CONTENT ================= -->
        <main class="-mt-6 relative z-0 px-4">

            <!-- TAB 1: ITINERARY (行程) -->
            <div v-if="currentTab === 'itinerary'" class="space-y-4">
                
                <!-- Date Selector -->
                <div class="flex overflow-x-auto no-scrollbar space-x-3 pb-2 pt-8">
                    <div 
                        v-for="(day, index) in tripDates" 
                        :key="day.dateStr"
                        @click="selectedDateIndex = index"
                        :class="[
                            'flex-shrink-0 flex flex-col items-center justify-center w-16 h-20 rounded-2xl border transition-all cursor-pointer',
                            selectedDateIndex === index 
                                ? 'bg-kuma-black text-white border-kuma-black shadow-lg transform -translate-y-1' 
                                : 'bg-white text-gray-400 border-gray-100 shadow-sm'
                        ]"
                    >
                        <span class="text-xs font-medium">{{ day.dayOfWeek }}</span>
                        <span class="text-2xl font-bold">{{ day.dayNumber }}</span>
                    </div>
                </div>

                <!-- Weather Widget -->
                <div class="bg-gradient-to-r from-blue-400 to-blue-300 rounded-2xl p-4 text-white shadow-md flex items-center justify-between">
                    <div>
                        <div class="text-sm opacity-90">阿蘇/熊本 天氣預報</div>
                        <div class="text-3xl font-bold mt-1">
                            {{ mockWeather(selectedDateIndex).temp }}°C
                        </div>
                        <div class="text-xs mt-1 opacity-80">體感 {{ mockWeather(selectedDateIndex).feelsLike }}°C</div>
                    </div>
                    <div class="flex flex-col items-center">
                        <i :class="mockWeather(selectedDateIndex).icon + ' text-4xl'"></i>
                        <span class="text-xs mt-1">{{ mockWeather(selectedDateIndex).desc }}</span>
                    </div>
                </div>

                <!-- AI Guide Button -->
                <button 
                    @click="askAIGuide"
                    class="w-full bg-white border border-purple-200 text-purple-600 font-bold py-3 rounded-2xl shadow-sm flex items-center justify-center space-x-2 active:scale-98 transition-all"
                >
                    <i class="fa-solid fa-wand-magic-sparkles text-lg"></i>
                    <span>AI 隨身導遊：分析本日行程</span>
                </button>

                <!-- Itinerary List -->
                <div class="space-y-4 pb-24">
                    <div v-if="currentDayItinerary.length === 0" class="text-center py-10 text-gray-400">
                        <i class="fa-solid fa-map-location-dot text-4xl mb-3"></i>
                        <p>本日尚無行程，點擊右下角新增</p>
                    </div>

                    <div 
                        v-for="(item, index) in currentDayItinerary" 
                        :key="item.id"
                        class="relative group"
                    >
                        <!-- Travel Time -->
                        <div v-if="index > 0" class="flex justify-center py-2 items-center text-xs text-gray-400 space-x-2">
                            <i :class="getTransportIcon(item.transportType)"></i>
                            <span class="border-b border-dashed border-gray-300 px-2">{{ item.transportTime || '15' }} 分鐘</span>
                            <i class="fa-solid fa-arrow-down text-[10px]"></i>
                        </div>
                         <div v-else class="flex justify-center py-2 items-center text-xs text-gray-400 space-x-2">
                            <i class="fa-solid fa-hotel"></i>
                            <span class="border-b border-dashed border-gray-300 px-2">從飯店出發</span>
                            <i class="fa-solid fa-arrow-down text-[10px]"></i>
                        </div>

                        <!-- Card -->
                        <div 
                            @click="openMap(item.name)"
                            :class="[
                                'bg-white rounded-2xl p-4 shadow-card border-l-4 relative overflow-hidden active:scale-98 transition-transform cursor-pointer',
                                item.type === 'flight' ? 'border-aso-blue bg-blue-50' : 
                                item.type === 'food' ? 'border-orange-400' :
                                item.type === 'shopping' ? 'border-pink-400' :
                                'border-aso-green'
                            ]"
                        >
                            <div class="absolute right-2 top-2 text-gray-300">
                                <i class="fa-solid fa-grip-lines"></i>
                            </div>

                            <!-- Flight Layout -->
                            <div v-if="item.type === 'flight'" class="flex flex-col">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="bg-blue-100 text-blue-600 text-xs px-2 py-1 rounded-full font-bold">
                                        <i class="fa-solid fa-plane-up mr-1"></i> {{ item.name }}
                                    </span>
                                    <span class="text-lg font-bold text-gray-700">{{ item.time }}</span>
                                </div>
                                <div class="flex justify-between items-end">
                                    <div class="text-sm text-gray-600">{{ item.memo }}</div>
                                </div>
                            </div>

                            <!-- Standard Layout -->
                            <div v-else class="flex items-start">
                                <div class="flex flex-col items-center mr-4 pt-1 min-w-[50px]">
                                    <span class="text-lg font-bold text-gray-800 leading-none">{{ item.time.split(':')[0] }}</span>
                                    <span class="text-xs text-gray-500">{{ item.time.split(':')[1] }}</span>
                                </div>
                                
                                <div class="flex-1">
                                    <h3 class="font-bold text-gray-800 text-lg leading-tight mb-1">
                                        {{ item.name }} 
                                        <i class="fa-solid fa-location-arrow text-[10px] text-aso-blue ml-1 opacity-50"></i>
                                    </h3>
                                    
                                    <div class="flex flex-wrap gap-2 text-xs text-gray-500 mb-2">
                                        <span v-if="item.hours" class="bg-gray-100 px-2 py-0.5 rounded text-gray-600">
                                            <i class="fa-regular fa-clock mr-1"></i>{{ item.hours }}
                                        </span>
                                        <span v-if="item.ticket" class="bg-yellow-50 px-2 py-0.5 rounded text-yellow-700">
                                            <i class="fa-solid fa-ticket mr-1"></i>{{ item.ticket }}
                                        </span>
                                    </div>

                                    <p v-if="item.memo" class="text-sm text-gray-600 bg-gray-50 p-2 rounded-lg border border-gray-100">
                                        <i class="fa-solid fa-circle-info text-kuma-red mr-1"></i>
                                        {{ item.memo }}
                                    </p>
                                </div>
                            </div>
                            
                            <button @click.stop="editItem(item)" class="absolute bottom-2 right-2 p-2 text-gray-300 hover:text-gray-500 z-10">
                                <i class="fa-solid fa-pen-to-square"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Add Button -->
                <button @click="openAddModal" class="fixed bottom-24 right-6 w-14 h-14 bg-kuma-black text-white rounded-full shadow-xl flex items-center justify-center text-2xl active:scale-90 transition-transform z-30">
                    <i class="fa-solid fa-plus"></i>
                </button>
            </div>

            <!-- TAB 2: INFO (資訊) -->
            <div v-else-if="currentTab === 'info'" class="space-y-6 pt-6 pb-24">
                <!-- Info content -->
                 <div class="bg-white rounded-2xl p-5 shadow-card">
                    <h2 class="text-lg font-bold mb-3 flex items-center"><i class="fa-solid fa-coins text-yellow-500 mr-2"></i> 匯率換算</h2>
                    <div class="flex items-center space-x-2 bg-gray-50 p-3 rounded-xl border border-gray-200">
                        <span class="text-gray-500 font-bold">¥</span>
                        <input v-model="currencyInput" type="number" placeholder="輸入日幣金額" class="bg-transparent w-full outline-none font-bold text-lg">
                    </div>
                    <div class="flex justify-between items-center mt-3 px-1">
                        <span class="text-xs text-gray-400">匯率: {{ exchangeRate }}</span>
                        <div class="text-xl font-bold text-kuma-red">NT$ {{ calculateTWD }}</div>
                    </div>
                </div>
                 
                 <div class="bg-white rounded-2xl p-5 shadow-card overflow-hidden relative">
                    <div class="absolute top-0 left-0 w-2 h-full bg-aso-blue"></div>
                    <h2 class="text-lg font-bold mb-4 flex items-center"><i class="fa-solid fa-plane text-aso-blue mr-2"></i> 航班資訊</h2>
                    <div class="mb-4 border-b border-dashed border-gray-200 pb-4">
                        <div class="flex justify-between text-xs text-gray-500 mb-1">
                            <span>2/10 (二) 去程</span><span class="font-bold text-aso-blue">IT766</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <div class="text-center"><div class="text-2xl font-black">KHH</div><div class="text-xs">08:45</div></div>
                            <div class="flex-1 flex flex-col items-center px-2"><i class="fa-solid fa-plane text-gray-300 text-xs"></i><div class="w-full h-[1px] bg-gray-300 my-1"></div><div class="text-[10px] text-gray-400">2h 05m</div></div>
                            <div class="text-center"><div class="text-2xl font-black">KMJ</div><div class="text-xs">11:50</div></div>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between text-xs text-gray-500 mb-1">
                            <span>2/17 (二) 回程</span><span class="font-bold text-aso-blue">IT767</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <div class="text-center"><div class="text-2xl font-black">KMJ</div><div class="text-xs">19:50</div></div>
                            <div class="flex-1 flex flex-col items-center px-2"><i class="fa-solid fa-plane rotate-180 text-gray-300 text-xs"></i><div class="w-full h-[1px] bg-gray-300 my-1"></div><div class="text-[10px] text-gray-400">2h 55m</div></div>
                            <div class="text-center"><div class="text-2xl font-black">KHH</div><div class="text-xs">21:45</div></div>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-2xl p-5 shadow-card">
                    <h2 class="text-lg font-bold mb-3 flex items-center"><i class="fa-solid fa-car text-aso-green mr-2"></i> 租車資訊</h2>
                    <div class="text-sm space-y-2">
                        <div class="flex justify-between"><span class="text-gray-500">公司</span> <span class="font-bold">Toyota Rent a Car</span></div>
                        <div class="flex justify-between"><span class="text-gray-500">取車</span> <span>2/11 09:00 (熊本站前)</span></div>
                        <div class="flex justify-between"><span class="text-gray-500">還車</span> <span>2/15 18:00 (熊本站前)</span></div>
                        <div class="bg-gray-100 p-2 rounded text-xs text-gray-600 mt-2"><i class="fa-solid fa-check text-green-500"></i> Yaris 同級 | 雪胎 | 3歲汽座</div>
                        <button @click="openMap('Toyota Rent a Car Kumamoto Station')" class="w-full mt-3 py-2 bg-aso-green text-white rounded-lg text-sm font-bold shadow">導航至租車處</button>
                    </div>
                </div>

                <div class="bg-white rounded-2xl p-5 shadow-card">
                    <h2 class="text-lg font-bold mb-3 flex items-center"><i class="fa-solid fa-bed text-purple-500 mr-2"></i> 住宿清單</h2>
                    <div class="space-y-4">
                        <div v-for="hotel in hotels" :key="hotel.name" class="flex justify-between items-start border-b border-gray-100 pb-3 last:border-0 last:pb-0">
                            <div><div class="font-bold text-sm">{{ hotel.name }}</div><div class="text-xs text-gray-500 mt-1">{{ hotel.date }}</div></div>
                            <button @click="openMap(hotel.name)" class="text-aso-blue text-xs border border-aso-blue px-2 py-1 rounded"><i class="fa-solid fa-location-arrow"></i></button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB 3: SHOPPING (購物清單) -->
            <div v-else-if="currentTab === 'shopping'" class="space-y-4 pt-6 pb-24">
                
                <!-- Quick Add Section (New Feature) -->
                <div class="bg-white p-4 rounded-2xl shadow-card">
                    <div class="text-sm font-bold text-gray-600 mb-2">快速新增推薦清單</div>
                    
                    <!-- Categories -->
                    <div class="flex space-x-2 overflow-x-auto no-scrollbar mb-3">
                        <button 
                            v-for="cat in Object.keys(presetShoppingItems)" 
                            :key="cat"
                            @click="selectedPresetCategory = cat"
                            :class="[
                                'px-3 py-1 rounded-full text-xs font-bold whitespace-nowrap transition-colors',
                                selectedPresetCategory === cat ? 'bg-pink-500 text-white' : 'bg-gray-100 text-gray-500'
                            ]"
                        >
                            {{ cat }}
                        </button>
                    </div>

                    <!-- Items -->
                    <div class="flex flex-wrap gap-2">
                        <button 
                            v-for="item in presetShoppingItems[selectedPresetCategory]" 
                            :key="item"
                            @click="addPresetItem(item)"
                            class="bg-pink-50 text-pink-600 px-3 py-1.5 rounded-lg text-xs font-medium border border-pink-100 active:scale-95 transition-transform flex items-center"
                        >
                            <i class="fa-solid fa-plus mr-1"></i> {{ item }}
                        </button>
                    </div>
                </div>

                <div class="bg-white p-4 rounded-2xl shadow-card flex items-center justify-between">
                    <h2 class="font-bold text-xl">購物清單</h2>
                    <span class="text-xs bg-gray-100 px-2 py-1 rounded-full text-gray-500">{{ shoppingList.length }} 項商品</span>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div 
                        v-for="(item, index) in shoppingList" 
                        :key="index" 
                        @click="editShoppingItem(item, index)"
                        class="bg-white rounded-xl shadow-sm overflow-hidden relative group active:scale-98 transition-transform cursor-pointer"
                    >
                        <div class="h-32 bg-gray-100 flex items-center justify-center overflow-hidden">
                            <img v-if="item.image" :src="item.image" class="w-full h-full object-cover">
                            <i v-else class="fa-solid fa-image text-gray-300 text-3xl"></i>
                        </div>
                        <div class="p-3">
                            <h3 class="font-bold text-sm truncate">{{ item.name }}</h3>
                            <div class="flex justify-between items-center mt-2">
                                <span class="text-[10px] bg-gray-100 text-gray-500 px-1.5 py-0.5 rounded">編輯</span>
                                <button @click.stop="deleteShoppingItem(index)" class="text-xs text-red-400 p-1"><i class="fa-solid fa-trash"></i></button>
                            </div>
                        </div>
                    </div>
                </div>

                 <button @click="openShoppingModal" class="fixed bottom-24 right-6 w-14 h-14 bg-pink-500 text-white rounded-full shadow-xl flex items-center justify-center text-2xl active:scale-90 transition-transform z-30">
                    <i class="fa-solid fa-cart-plus"></i>
                </button>
            </div>

            <!-- TAB 4: EXPENSES (花費) -->
            <div v-else-if="currentTab === 'expenses'" class="space-y-4 pt-6 pb-24">
                
                <div class="bg-kuma-black text-white rounded-2xl p-6 shadow-card">
                    <div class="text-sm opacity-70 mb-1">總花費 (JPY)</div>
                    <div class="text-4xl font-bold">¥{{ totalExpenses.toLocaleString() }}</div>
                    <div class="mt-4 flex space-x-2 overflow-x-auto text-xs">
                        <span class="bg-gray-800 px-3 py-1 rounded-full">飲食 ¥{{ expensesByCategory.food.toLocaleString() }}</span>
                        <span class="bg-gray-800 px-3 py-1 rounded-full">購物 ¥{{ expensesByCategory.shopping.toLocaleString() }}</span>
                        <span class="bg-gray-800 px-3 py-1 rounded-full">交通 ¥{{ expensesByCategory.transport.toLocaleString() }}</span>
                    </div>
                </div>

                <div class="bg-white rounded-2xl shadow-card overflow-hidden">
                    <div v-if="expenseList.length === 0" class="p-8 text-center text-gray-400 text-sm">
                        尚未新增紀錄
                    </div>
                    <div v-for="(exp, index) in expenseList" :key="index" class="p-4 border-b border-gray-100 flex justify-between items-center last:border-0">
                        <div class="flex items-center">
                            <div :class="['w-10 h-10 rounded-full flex items-center justify-center text-white mr-3', getCategoryColor(exp.category)]">
                                <i :class="getCategoryIcon(exp.category)"></i>
                            </div>
                            <div>
                                <div class="font-bold text-sm">{{ exp.name }}</div>
                                <div class="text-xs text-gray-400">{{ exp.date }} · {{ exp.payment }}</div>
                            </div>
                        </div>
                        <div class="font-bold text-gray-800">¥{{ parseInt(exp.amount).toLocaleString() }}</div>
                        <button @click="deleteExpense(index)" class="ml-2 text-gray-300 hover:text-red-400"><i class="fa-solid fa-xmark"></i></button>
                    </div>
                </div>

                <button @click="openExpenseModal" class="fixed bottom-24 right-6 w-14 h-14 bg-yellow-500 text-white rounded-full shadow-xl flex items-center justify-center text-2xl active:scale-90 transition-transform z-30">
                    <i class="fa-solid fa-yen-sign"></i>
                </button>
            </div>

        </main>

        <!-- ================= MODALS ================= -->

        <!-- Settings Modal (New) -->
        <div v-if="showSettingsModal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl w-full max-w-sm p-5">
                <h3 class="text-xl font-bold mb-4">設定</h3>
                
                <div class="mb-4">
                    <label class="text-xs font-bold text-gray-500 block mb-1">Gemini API Key</label>
                    <input v-model="userApiKey" type="password" class="w-full bg-gray-100 p-3 rounded-lg text-sm" placeholder="貼上您的 API Key">
                    <p class="text-[10px] text-gray-400 mt-2">
                        說明：若在 GitHub Pages 上使用 AI 功能，需自行申請並輸入 API Key。您的 Key 僅會儲存在手機瀏覽器中。
                        <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-blue-500 underline">取得 Key</a>
                    </p>
                </div>

                <div class="flex gap-2">
                    <button @click="saveSettings" class="flex-1 bg-kuma-black text-white py-3 rounded-xl font-bold">儲存</button>
                    <button @click="showSettingsModal = false" class="px-4 py-3 text-gray-400">取消</button>
                </div>
            </div>
        </div>

        <!-- AI Loading / Result Modal -->
        <div v-if="showAIModal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl w-full max-w-sm max-h-[80vh] overflow-y-auto p-6 relative">
                <button @click="showAIModal = false" class="absolute top-4 right-4 text-gray-400"><i class="fa-solid fa-xmark text-xl"></i></button>
                
                <div class="text-center mb-4">
                    <div class="w-12 h-12 bg-purple-100 text-purple-600 rounded-full flex items-center justify-center mx-auto mb-2">
                        <i class="fa-solid fa-wand-magic-sparkles text-xl"></i>
                    </div>
                    <h3 class="text-xl font-bold">AI 隨身導遊</h3>
                </div>

                <!-- Loading State -->
                <div v-if="isAiLoading" class="text-center py-8">
                    <i class="fa-solid fa-circle-notch fa-spin text-4xl text-purple-500 mb-4"></i>
                    <p class="text-gray-500 animate-pulse">正在分析您的行程...</p>
                    <p class="text-xs text-gray-400 mt-2">Gemini 正在搜尋附近美食與景點 ✨</p>
                </div>

                <!-- Result Content -->
                <div v-else class="ai-response text-sm text-gray-700 leading-relaxed" v-html="aiResponse"></div>
                
                <button v-if="!isAiLoading" @click="showAIModal = false" class="w-full mt-6 bg-purple-600 text-white py-3 rounded-xl font-bold">知道了</button>
            </div>
        </div>

        <!-- Itinerary Edit/Add Modal -->
        <div v-if="showItineraryModal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl w-full max-w-sm max-h-[90vh] overflow-y-auto p-5">
                <h3 class="text-xl font-bold mb-4">{{ isEditing ? '編輯行程' : '新增行程' }}</h3>
                
                <div class="space-y-3">
                    <div>
                        <label class="text-xs font-bold text-gray-500">名稱</label>
                        <input v-model="formItinerary.name" class="w-full bg-gray-100 p-2 rounded-lg" placeholder="例如: 熊本城">
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="text-xs font-bold text-gray-500">分類</label>
                            <select v-model="formItinerary.type" class="w-full bg-gray-100 p-2 rounded-lg">
                                <option value="sight">景點</option>
                                <option value="food">美食</option>
                                <option value="shopping">購物</option>
                                <option value="hotel">住宿</option>
                                <option value="other">其他</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-xs font-bold text-gray-500">時間</label>
                            <input type="time" v-model="formItinerary.time" class="w-full bg-gray-100 p-2 rounded-lg">
                        </div>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-500">交通方式 (到此地)</label>
                        <div class="flex space-x-2 mt-1">
                            <button @click="formItinerary.transportType = 'car'" :class="['flex-1 py-2 rounded-lg text-sm', formItinerary.transportType === 'car' ? 'bg-kuma-black text-white' : 'bg-gray-100']"><i class="fa-solid fa-car"></i></button>
                            <button @click="formItinerary.transportType = 'walk'" :class="['flex-1 py-2 rounded-lg text-sm', formItinerary.transportType === 'walk' ? 'bg-kuma-black text-white' : 'bg-gray-100']"><i class="fa-solid fa-person-walking"></i></button>
                            <button @click="formItinerary.transportType = 'public'" :class="['flex-1 py-2 rounded-lg text-sm', formItinerary.transportType === 'public' ? 'bg-kuma-black text-white' : 'bg-gray-100']"><i class="fa-solid fa-bus"></i></button>
                        </div>
                    </div>
                     <div>
                        <label class="text-xs font-bold text-gray-500">交通時間 (分鐘)</label>
                        <input type="number" v-model="formItinerary.transportTime" class="w-full bg-gray-100 p-2 rounded-lg" placeholder="15">
                    </div>
                    <div v-if="formItinerary.type !== 'flight'">
                        <label class="text-xs font-bold text-gray-500">營業時間/備註</label>
                        <textarea v-model="formItinerary.memo" class="w-full bg-gray-100 p-2 rounded-lg h-20"></textarea>
                    </div>
                    <div v-if="formItinerary.type === 'sight'">
                        <label class="text-xs font-bold text-gray-500">門票資訊</label>
                        <input v-model="formItinerary.ticket" class="w-full bg-gray-100 p-2 rounded-lg" placeholder="例如: 成人800円">
                    </div>
                </div>
                <div class="flex gap-2 mt-6">
                    <button v-if="isEditing" @click="confirmDeleteItinerary" class="flex-1 bg-red-100 text-red-500 py-3 rounded-xl font-bold">刪除</button>
                    <button @click="saveItinerary" class="flex-1 bg-kuma-black text-white py-3 rounded-xl font-bold">儲存</button>
                    <button @click="showItineraryModal = false" class="px-4 py-3 text-gray-400">取消</button>
                </div>
            </div>
        </div>

        <!-- Shopping Modal -->
        <div v-if="showShoppingModal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
             <div class="bg-white rounded-2xl w-full max-w-sm p-5">
                <h3 class="text-xl font-bold mb-4">{{ isEditingShopping ? '編輯商品' : '新增購物清單' }}</h3>
                <input v-model="formShopping.name" class="w-full bg-gray-100 p-3 rounded-lg mb-3" placeholder="商品名稱">
                
                <label class="block w-full h-32 bg-gray-100 rounded-lg flex flex-col items-center justify-center cursor-pointer text-gray-400 border-2 border-dashed border-gray-300 hover:border-kuma-red relative overflow-hidden">
                    <div v-if="!formShopping.image" class="flex flex-col items-center pointer-events-none">
                        <i class="fa-solid fa-camera text-2xl mb-2"></i>
                        <span class="text-xs">點擊上傳圖片</span>
                    </div>
                    <input type="file" @change="handleImageUpload" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" accept="image/*">
                    <img v-if="formShopping.image" :src="formShopping.image" class="w-full h-full object-cover pointer-events-none">
                </label>

                <div class="flex gap-2 mt-4">
                    <button @click="saveShoppingItem" class="flex-1 bg-pink-500 text-white py-3 rounded-xl font-bold">儲存</button>
                    <button @click="showShoppingModal = false" class="px-4 py-3 text-gray-400">取消</button>
                </div>
             </div>
        </div>

        <!-- Expense Modal (Updated with AI Scan) -->
        <div v-if="showExpenseModal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl w-full max-w-sm p-5">
               <h3 class="text-xl font-bold mb-4">記帳</h3>
               
               <!-- AI Scan Button -->
               <div class="mb-4">
                   <label class="w-full bg-gradient-to-r from-purple-500 to-indigo-500 text-white py-3 rounded-xl font-bold flex items-center justify-center cursor-pointer shadow-md hover:opacity-90 transition-opacity">
                       <i class="fa-solid fa-camera mr-2" :class="{'fa-spin': isScannerLoading}"></i> 
                       <span>{{ isScannerLoading ? 'AI 辨識中...' : '✨ AI 掃描收據' }}</span>
                       <input type="file" class="hidden" accept="image/*" @change="handleReceiptScan" :disabled="isScannerLoading">
                   </label>
                   <p class="text-[10px] text-gray-400 text-center mt-1">支援辨識日本收據，自動填寫金額與分類</p>
               </div>

               <div class="space-y-3 relative">
                   <!-- Overlay when scanning -->
                   <div v-if="isScannerLoading" class="absolute inset-0 bg-white/80 z-10 flex flex-col items-center justify-center rounded-lg">
                       <p class="text-purple-600 font-bold animate-pulse">Gemini 正在讀取...</p>
                   </div>

                   <select v-model="formExpense.category" class="w-full bg-gray-100 p-3 rounded-lg">
                       <option value="food">飲食</option>
                       <option value="transport">交通</option>
                       <option value="shopping">購物</option>
                       <option value="hotel">住宿</option>
                       <option value="ticket">門票</option>
                       <option value="other">其他</option>
                   </select>
                   <input v-model="formExpense.name" class="w-full bg-gray-100 p-3 rounded-lg" placeholder="項目名稱 (例如: 拉麵)">
                   <input type="number" v-model="formExpense.amount" class="w-full bg-gray-100 p-3 rounded-lg" placeholder="金額 (JPY)">
                   
                   <div class="flex space-x-2">
                        <button @click="formExpense.payment = 'cash'" :class="['flex-1 py-2 rounded-lg text-sm', formExpense.payment === 'cash' ? 'bg-yellow-500 text-white' : 'bg-gray-100']">現金</button>
                        <button @click="formExpense.payment = 'card'" :class="['flex-1 py-2 rounded-lg text-sm', formExpense.payment === 'card' ? 'bg-blue-500 text-white' : 'bg-gray-100']">信用卡</button>
                   </div>
                   
                   <!-- Auto-filled date -->
                   <div class="text-xs text-gray-400 text-center mt-1">
                       日期: {{ formExpense.date }}
                   </div>
               </div>

               <div class="flex gap-2 mt-6">
                   <button @click="saveExpense" class="flex-1 bg-yellow-500 text-white py-3 rounded-xl font-bold">儲存</button>
                   <button @click="showExpenseModal = false" class="px-4 py-3 text-gray-400">取消</button>
               </div>
            </div>
       </div>

    </div>

    <!-- VUE JS APPLICATION LOGIC -->
    <script>
        const { createApp, ref, computed, onMounted, watch } = Vue;
        
        // Gemini API Configuration
        const GEMINI_MODEL = "gemini-2.5-flash-preview-09-2025";
        
        // Get API Key from localStorage or use default (empty in GitHub Pages)
        const getApiKey = () => localStorage.getItem('gemini_api_key') || ""; 

        // Helper to call Gemini
        const callGemini = async (prompt) => {
            const key = getApiKey();
            if (!key) {
                return "請點擊右上角設定圖示，輸入您的 Gemini API Key 才能使用此功能喔！";
            }
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${key}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await response.json();
                if (data.error) throw new Error(data.error.message);
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "抱歉，AI 暫時無法回應。";
            } catch (error) {
                console.error("Gemini Error:", error);
                return `發生錯誤：${error.message || "網路連線錯誤"}`;
            }
        };

        // Helper to call Gemini Vision
        const callGeminiVision = async (prompt, base64Image) => {
            const key = getApiKey();
            if (!key) {
                alert("請點擊右上角設定圖示，輸入您的 Gemini API Key 才能使用此功能喔！");
                throw new Error("Missing API Key");
            }
            try {
                // Remove header if present (e.g., "data:image/jpeg;base64,")
                const base64Data = base64Image.split(',')[1];
                
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${key}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { text: prompt },
                                { inline_data: { mime_type: "image/jpeg", data: base64Data } }
                            ]
                        }]
                    })
                });
                const data = await response.json();
                if (data.error) throw new Error(data.error.message);
                return data.candidates?.[0]?.content?.parts?.[0]?.text;
            } catch (error) {
                console.error("Gemini Vision Error:", error);
                alert(`AI 掃描失敗：${error.message}`);
                return null;
            }
        };

        createApp({
            setup() {
                // ================= STATE =================
                const currentTab = ref('itinerary');
                const selectedDateIndex = ref(0);
                
                // Modals
                const showItineraryModal = ref(false);
                const showShoppingModal = ref(false);
                const showExpenseModal = ref(false);
                const showAIModal = ref(false);
                const showSettingsModal = ref(false); // New
                
                // User Settings
                const userApiKey = ref(localStorage.getItem('gemini_api_key') || '');
                
                // AI States
                const isAiLoading = ref(false);
                const aiResponse = ref('');
                const isScannerLoading = ref(false);

                const isEditing = ref(false);
                const isEditingShopping = ref(false);
                const editingShoppingIndex = ref(-1);
                const currencyInput = ref('');
                
                // Quick Add Shopping Logic
                const selectedPresetCategory = ref('藥妝');
                const presetShoppingItems = {
                    '藥妝': ['合利他命 EX', 'Wakamoto 若元錠', 'EVE 止痛藥', '大正感冒藥', 'Chocola BB', 'DHC 維他命', '蒸氣眼罩'],
                    '零食': ['一蘭拉麵包', 'Calbee 薯條三兄弟', '白色戀人', 'KitKat 抹茶', 'Pocky 限定版', '梅干片', '味覺糖'],
                    '電器': ['Panasonic 吹風機', 'Dyson 吸塵器', '電子鍋', '刮鬍刀', 'Switch 遊戲片'],
                    '伴手禮': ['熊本熊周邊', '阿蘇牛奶餅乾', '九州鬆餅粉', '明太子', '柚子胡椒'],
                    '母嬰': ['阿卡將童裝', '貝親奶瓶', '明治奶粉塊', '麵包超人玩具', '兒童牙刷']
                };

                // Tabs Config
                const tabs = [
                    { id: 'itinerary', name: '行程', icon: 'fa-solid fa-map-location-dot' },
                    { id: 'info', name: '資訊', icon: 'fa-solid fa-circle-info' },
                    { id: 'shopping', name: '購物', icon: 'fa-solid fa-basket-shopping' },
                    { id: 'expenses', name: '花費', icon: 'fa-solid fa-yen-sign' }
                ];

                const tripDates = [
                    { dateStr: '2025-02-10', dayOfWeek: 'Tue', dayNumber: '10' },
                    { dateStr: '2025-02-11', dayOfWeek: 'Wed', dayNumber: '11' },
                    { dateStr: '2025-02-12', dayOfWeek: 'Thu', dayNumber: '12' },
                    { dateStr: '2025-02-13', dayOfWeek: 'Fri', dayNumber: '13' },
                    { dateStr: '2025-02-14', dayOfWeek: 'Sat', dayNumber: '14' },
                    { dateStr: '2025-02-15', dayOfWeek: 'Sun', dayNumber: '15' },
                    { dateStr: '2025-02-16', dayOfWeek: 'Mon', dayNumber: '16' },
                    { dateStr: '2025-02-17', dayOfWeek: 'Tue', dayNumber: '17' },
                ];

                const defaultItinerary = {
                    '2025-02-10': [
                        { id: 1, type: 'flight', name: 'IT766 抵達熊本', time: '11:50', memo: '08:45 KHH 出發', transportType: 'plane' },
                        { id: 2, type: 'hotel', name: 'ONE STATION HOTEL Check-in', time: '13:30', memo: '飯店入住', transportType: 'public', transportTime: 40 },
                        { id: 3, type: 'shopping', name: '下通商店街', time: '14:30', memo: '採買小孩備品', transportType: 'walk', transportTime: 10 },
                        { id: 4, type: 'sight', name: '熊本熊廣場', time: '16:00', memo: '看表演', transportType: 'walk', transportTime: 10 },
                        { id: 5, type: 'food', name: '熊本車站商場餐廳', time: '18:30', memo: '晚餐', transportType: 'public', transportTime: 15 }
                    ],
                    '2025-02-11': [
                        { id: 6, type: 'other', name: '熊本取車', time: '09:00', memo: '熊本站前店 (Toyota)', transportType: 'walk', transportTime: 10 },
                        { id: 7, type: 'sight', name: '別府地獄巡禮', time: '12:30', memo: '海地獄、鬼山地獄', transportType: 'car', transportTime: 150 },
                        { id: 8, type: 'food', name: '鐵輪溫泉地獄蒸', time: '13:30', memo: '推薦：茶寮大路', transportType: 'walk', transportTime: 5 },
                        { id: 9, type: 'hotel', name: '別府龜之井飯店', time: '16:00', memo: 'Check-in', transportType: 'car', transportTime: 15 }
                    ],
                    '2025-02-12': [
                        { id: 10, type: 'sight', name: '九州自然野生動物園', time: '09:30', memo: '15:00 叢林巴士(已預約), 先排隊試更換早場', transportType: 'car', transportTime: 30 },
                        { id: 11, type: 'food', name: '別府冷麵', time: '12:30', memo: '午餐', transportType: 'car', transportTime: 20 },
                        { id: 12, type: 'sight', name: '大分水族館「海之卵」', time: '14:30', memo: '看海豚表演', transportType: 'car', transportTime: 20 }
                    ],
                    '2025-02-13': [
                        { id: 13, type: 'sight', name: '卡德利動物園', time: '10:30', memo: '喂黑熊、狗狗互動. 09:45 嘗試預約直升機', transportType: 'car', transportTime: 60 },
                        { id: 14, type: 'sight', name: '阿蘇神社水基巡禮', time: '14:00', memo: '散步', transportType: 'car', transportTime: 15 },
                        { id: 15, type: 'hotel', name: '阿蘇龜之井飯店', time: '16:00', memo: 'Check-in (含早晚餐)', transportType: 'car', transportTime: 20 }
                    ],
                    '2025-02-14': [
                        { id: 16, type: 'sight', name: '草千里', time: '09:30', memo: '雪地玩耍、騎馬 (需雪胎)', transportType: 'car', transportTime: 30 },
                        { id: 17, type: 'sight', name: '阿蘇火山博物館', time: '11:00', memo: '火山口關閉替代方案', transportType: 'car', transportTime: 5 },
                        { id: 18, type: 'food', name: 'いまきん食堂', time: '12:30', memo: '赤牛丼', transportType: 'car', transportTime: 20 },
                        { id: 19, type: 'sight', name: '大觀峰', time: '14:30', memo: '360度俯瞰阿蘇五岳', transportType: 'car', transportTime: 20 },
                        { id: 20, type: 'other', name: '前往高千穗', time: '16:00', memo: '車程約1小時', transportType: 'car', transportTime: 60 }
                    ],
                    '2025-02-15': [
                        { id: 21, type: 'food', name: '千穗之家', time: '11:30', memo: '流水麵', transportType: 'car', transportTime: 10 },
                        { id: 22, type: 'sight', name: '高千穗峽划船', time: '13:30', memo: '需 2/1 搶票', transportType: 'walk', transportTime: 10 },
                        { id: 23, type: 'sight', name: '天安河原', time: '15:30', memo: '疊石許願', transportType: 'car', transportTime: 15 },
                        { id: 24, type: 'other', name: '熊本站還車', time: '18:00', memo: 'Toyota 站前店還車', transportType: 'car', transportTime: 120 },
                        { id: 25, type: 'hotel', name: 'CANDEO HOTEL', time: '19:00', memo: 'Check-in', transportType: 'public', transportTime: 20 }
                    ],
                    '2025-02-16': [
                        { id: 26, type: 'sight', name: '熊本城', time: '09:30', memo: '參觀', transportType: 'public', transportTime: 15 },
                        { id: 27, type: 'sight', name: '櫻之馬場 城彩苑', time: '11:30', memo: '逛街', transportType: 'walk', transportTime: 10 },
                        { id: 28, type: 'food', name: '勝烈亭豬排', time: '13:00', memo: '午餐', transportType: 'walk', transportTime: 15 },
                        { id: 29, type: 'shopping', name: '市區藥妝', time: '15:00', memo: '最後採買', transportType: 'walk', transportTime: 10 },
                        { id: 30, type: 'food', name: '熊本黑亭拉麵', time: '18:00', memo: '晚餐', transportType: 'walk', transportTime: 10 }
                    ],
                    '2025-02-17': [
                        { id: 31, type: 'sight', name: '坪井川綠地公園', time: '10:00', memo: '超大遊具放電', transportType: 'public', transportTime: 30 },
                        { id: 32, type: 'flight', name: '前往機場', time: '15:30', memo: '17:50 前抵達', transportType: 'public', transportTime: 60 },
                        { id: 33, type: 'flight', name: 'IT767 返台', time: '19:50', memo: '21:45 抵達 KHH', transportType: 'plane' }
                    ]
                };

                const itineraryData = ref(JSON.parse(localStorage.getItem('itinerary')) || defaultItinerary);
                const shoppingList = ref(JSON.parse(localStorage.getItem('shopping')) || []);
                const expenseList = ref(JSON.parse(localStorage.getItem('expenses')) || []);

                // Forms
                const formItinerary = ref({});
                const formShopping = ref({ name: '', image: null });
                const formExpense = ref({ category: 'food', name: '', amount: '', payment: 'cash', date: '' });
                
                const hotels = [
                    { name: 'ONE STATION HOTEL KUMAMOTO', date: '2/10 (1晚)' },
                    { name: '別府龜之井飯店', date: '2/11-12 (2晚)' },
                    { name: '阿蘇龜之井飯店', date: '2/13-14 (2晚)' },
                    { name: 'CANDEO HOTEL 熊本新市街', date: '2/15-16 (2晚)' },
                ];

                // Computed
                const currentDateStr = computed(() => tripDates[selectedDateIndex.value].dateStr);
                
                const currentDayItinerary = computed(() => {
                    const list = itineraryData.value[currentDateStr.value] || [];
                    return list.sort((a, b) => a.time.localeCompare(b.time));
                });

                const exchangeRate = 0.2; 
                const calculateTWD = computed(() => {
                    return currencyInput.value ? Math.round(currencyInput.value * exchangeRate) : 0;
                });

                const totalExpenses = computed(() => {
                    return expenseList.value.reduce((sum, item) => sum + parseInt(item.amount || 0), 0);
                });

                const expensesByCategory = computed(() => {
                    const cats = { food: 0, shopping: 0, transport: 0 };
                    expenseList.value.forEach(item => {
                        if (cats[item.category] !== undefined) cats[item.category] += parseInt(item.amount);
                    });
                    return cats;
                });

                // Methods
                const mockWeather = (idx) => {
                    const weathers = [
                        { temp: 8, feelsLike: 5, icon: 'fa-solid fa-cloud-sun', desc: '多雲' },
                        { temp: 6, feelsLike: 3, icon: 'fa-solid fa-cloud-rain', desc: '小雨' }, 
                        { temp: 4, feelsLike: 0, icon: 'fa-solid fa-wind', desc: '強風' },
                        { temp: 2, feelsLike: -2, icon: 'fa-regular fa-snowflake', desc: '降雪' },
                        { temp: 0, feelsLike: -4, icon: 'fa-regular fa-snowflake', desc: '大雪' },
                        { temp: 5, feelsLike: 3, icon: 'fa-solid fa-sun', desc: '晴朗' },
                        { temp: 9, feelsLike: 7, icon: 'fa-solid fa-cloud', desc: '陰天' },
                        { temp: 11, feelsLike: 9, icon: 'fa-solid fa-sun', desc: '晴朗' }
                    ];
                    return weathers[idx] || weathers[0];
                };

                const getTransportIcon = (type) => {
                    const map = { car: 'fa-solid fa-car', walk: 'fa-solid fa-person-walking', public: 'fa-solid fa-bus', plane: 'fa-solid fa-plane' };
                    return map[type] || 'fa-solid fa-shoe-prints';
                };

                const getCategoryIcon = (cat) => {
                    const map = { food: 'fa-solid fa-utensils', transport: 'fa-solid fa-bus', shopping: 'fa-solid fa-bag-shopping', hotel: 'fa-solid fa-bed', ticket: 'fa-solid fa-ticket', other: 'fa-solid fa-circle' };
                    return map[cat];
                };

                const getCategoryColor = (cat) => {
                     const map = { food: 'bg-orange-400', transport: 'bg-blue-400', shopping: 'bg-pink-400', hotel: 'bg-purple-400', ticket: 'bg-green-500', other: 'bg-gray-400' };
                     return map[cat];
                };

                const openMap = (locationName) => {
                    if (!locationName) return;
                    let query = locationName;
                    window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(query)}`, '_blank');
                };

                // AI Features Logic
                const askAIGuide = async () => {
                    showAIModal.value = true;
                    isAiLoading.value = true;
                    
                    const itineraryText = currentDayItinerary.value.map(i => `${i.time} ${i.name} (${i.memo})`).join(', ');
                    const prompt = `你是一位專業的日本九州旅遊導遊。
                    今天是 ${currentDateStr.value}。
                    使用者的行程如下: [${itineraryText}]。
                    請針對這個行程提供 3 個簡短建議 (繁體中文):
                    1. 附近推薦的美食或隱藏景點 (填補空檔)。
                    2. 針對行程的實用提醒 (交通或路線)。
                    3. 今天的旅遊心情小語。
                    請用條列式，語氣親切可愛 (熊本熊風格)。`;

                    const result = await callGemini(prompt);
                    aiResponse.value = marked.parse(result);
                    isAiLoading.value = false;
                };

                const handleReceiptScan = async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;

                    isScannerLoading.value = true;
                    const reader = new FileReader();
                    
                    reader.onload = async (e) => {
                        const base64 = e.target.result;
                        const prompt = `你是一個收據辨識助手。請分析這張收據圖片 (可能是日文)，並擷取以下資訊，回傳純 JSON 格式 (不要有 markdown 標記):
                        {
                            "name": "商店名稱 (若不確定請填 '未知商店')",
                            "amount": "總金額 (數字)",
                            "category": "根據內容判斷類別，只能是以下之一: ['food', 'shopping', 'transport', 'hotel', 'ticket', 'other']",
                            "date": "YYYY-MM-DD (若找不到日期請回傳空字串)"
                        }`;

                        try {
                            const resultText = await callGeminiVision(prompt, base64);
                            if (resultText) {
                                // Cleanup JSON string if it contains markdown code blocks
                                const cleanJson = resultText.replace(/```json|```/g, '').trim();
                                const data = JSON.parse(cleanJson);
                                
                                // Auto fill form
                                formExpense.value.name = data.name;
                                formExpense.value.amount = data.amount;
                                formExpense.value.category = data.category || 'other';
                                if (data.date) formExpense.value.date = data.date;
                            }
                            
                        } catch (err) {
                            alert("辨識失敗，請手動輸入");
                            console.error(err);
                        } finally {
                            isScannerLoading.value = false;
                            // Reset input value so same file can be selected again
                            e.target.value = ''; 
                        }
                    };
                    reader.readAsDataURL(file);
                };

                const saveSettings = () => {
                    localStorage.setItem('gemini_api_key', userApiKey.value);
                    showSettingsModal.value = false;
                    alert('API Key 已儲存！');
                };

                const addPresetItem = (itemName) => {
                    shoppingList.value.push({ name: itemName, image: null });
                    saveToLocal('shopping', shoppingList.value);
                };

                // ... CRUD Methods (Unchanged) ...
                const openAddModal = () => {
                    isEditing.value = false;
                    formItinerary.value = { type: 'sight', transportType: 'car', time: '10:00' };
                    showItineraryModal.value = true;
                };

                const editItem = (item) => {
                    isEditing.value = true;
                    formItinerary.value = { ...item };
                    showItineraryModal.value = true;
                };

                const saveItinerary = () => {
                    const dateKey = currentDateStr.value;
                    if (!itineraryData.value[dateKey]) itineraryData.value[dateKey] = [];
                    
                    if (isEditing.value) {
                        const idx = itineraryData.value[dateKey].findIndex(i => i.id === formItinerary.value.id);
                        if (idx !== -1) itineraryData.value[dateKey][idx] = { ...formItinerary.value };
                    } else {
                        const newItem = { ...formItinerary.value, id: Date.now() };
                        itineraryData.value[dateKey].push(newItem);
                    }
                    saveToLocal('itinerary', itineraryData.value);
                    showItineraryModal.value = false;
                };

                const confirmDeleteItinerary = () => {
                    if(confirm('確定要刪除這個行程嗎？')) {
                        const dateKey = currentDateStr.value;
                        itineraryData.value[dateKey] = itineraryData.value[dateKey].filter(i => i.id !== formItinerary.value.id);
                        saveToLocal('itinerary', itineraryData.value);
                        showItineraryModal.value = false;
                    }
                };

                const openShoppingModal = () => {
                    isEditingShopping.value = false;
                    formShopping.value = { name: '', image: null };
                    showShoppingModal.value = true;
                };

                const editShoppingItem = (item, index) => {
                    isEditingShopping.value = true;
                    editingShoppingIndex.value = index;
                    formShopping.value = { ...item };
                    showShoppingModal.value = true;
                };

                const handleImageUpload = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => formShopping.value.image = e.target.result;
                        reader.readAsDataURL(file);
                    }
                };

                const saveShoppingItem = () => {
                    if(!formShopping.value.name) return;
                    if (isEditingShopping.value && editingShoppingIndex.value !== -1) {
                         shoppingList.value[editingShoppingIndex.value] = { ...formShopping.value };
                    } else {
                         shoppingList.value.push({ ...formShopping.value });
                    }
                    saveToLocal('shopping', shoppingList.value);
                    showShoppingModal.value = false;
                };

                const deleteShoppingItem = (index) => {
                    if(confirm('刪除此商品？')) {
                        shoppingList.value.splice(index, 1);
                        saveToLocal('shopping', shoppingList.value);
                    }
                };

                const openExpenseModal = () => {
                    formExpense.value = { category: 'food', name: '', amount: '', payment: 'cash', date: currentDateStr.value };
                    showExpenseModal.value = true;
                };

                const saveExpense = () => {
                    if(!formExpense.value.amount) return;
                    expenseList.value.unshift({ ...formExpense.value });
                    saveToLocal('expenses', expenseList.value);
                    showExpenseModal.value = false;
                };

                const deleteExpense = (index) => {
                    if(confirm('刪除此筆記帳？')) {
                        expenseList.value.splice(index, 1);
                        saveToLocal('expenses', expenseList.value);
                    }
                };

                const saveToLocal = (key, data) => {
                    localStorage.setItem(key, JSON.stringify(data));
                };

                return {
                    currentTab, tabs, tripDates, selectedDateIndex, currentDateStr, currentDayItinerary,
                    mockWeather, getTransportIcon, openMap,
                    showItineraryModal, isEditing, formItinerary, openAddModal, editItem, saveItinerary, confirmDeleteItinerary,
                    currencyInput, exchangeRate, calculateTWD, hotels,
                    shoppingList, showShoppingModal, formShopping, openShoppingModal, handleImageUpload, saveShoppingItem, deleteShoppingItem, isEditingShopping, editShoppingItem,
                    expenseList, showExpenseModal, formExpense, openExpenseModal, saveExpense, deleteExpense, totalExpenses, expensesByCategory, getCategoryIcon, getCategoryColor,
                    // AI Exports
                    askAIGuide, showAIModal, isAiLoading, aiResponse,
                    handleReceiptScan, isScannerLoading,
                    // Settings & New Features
                    showSettingsModal, userApiKey, saveSettings,
                    selectedPresetCategory, presetShoppingItems, addPresetItem
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
