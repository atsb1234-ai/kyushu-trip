<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¹å·ç†Šæœ¬è¦ªå­è‡ªé§•éŠ</title>
    
    <!-- PWA Settings -->
    <link rel="icon" type="image/svg+xml" href="app-icon.svg">
    <link rel="apple-touch-icon" href="app-icon.svg">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#ffffff">
    
    <!-- Google Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        kuma: { black: '#1a1a1a', red: '#FF5252', white: '#ffffff', gray: '#f3f4f6' },
                        aso: { green: '#66BB6A', brown: '#8D6E63', blue: '#42A5F5' }
                    },
                    fontFamily: { sans: ['Noto Sans TC', 'sans-serif'] },
                    boxShadow: { 'card': '0 4px 15px rgba(0, 0, 0, 0.05)' },
                    animation: { 
                        'bounce-slow': 'bounce 3s infinite',
                        'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite'
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #f0f2f5; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        input, select, textarea { font-size: 16px !important; }
        .glass-tab { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.5); }
        .header-curve { border-bottom-left-radius: 40px; border-bottom-right-radius: 40px; }
        .ai-response ul { list-style-type: disc; padding-left: 1.2em; margin: 0.5em 0; }
        .ticket-perforation {
            background-image: radial-gradient(circle at 0 50%, transparent 10px, white 11px), radial-gradient(circle at 100% 50%, transparent 10px, white 11px);
            background-size: 50% 100%;
            background-position: 0 0, 100% 0;
            background-repeat: no-repeat;
        }
        /* Recording Animation */
        .recording-ring { box-shadow: 0 0 0 0 rgba(255, 82, 82, 0.7); animation: recordingPulse 1.5s infinite; }
        @keyframes recordingPulse {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(255, 82, 82, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(255, 82, 82, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(255, 82, 82, 0); }
        }
    </style>
    
    <!-- Libraries -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body class="text-gray-800 font-sans antialiased">

    <div id="app" class="pb-20 min-h-screen relative">
        
        <!-- ================= HEADER SECTION ================= -->
        <header class="relative z-10">
            <!-- Settings Button -->
            <button @click="openSettings" class="absolute top-4 right-4 z-30 w-10 h-10 bg-black/30 backdrop-blur-sm text-white rounded-full flex items-center justify-center hover:bg-black/50 transition-colors">
                <i class="fa-solid fa-gear"></i>
            </button>

            <!-- Banner Image -->
            <div class="relative h-[250px] w-full header-curve overflow-hidden shadow-lg">
                <img src="ç†Šæœ¬é›„é˜¿è˜‡ç«å±±åœ–.png" onerror="this.src='https://images.unsplash.com/photo-1542051841857-5f90071e7989?q=80&w=1920&auto=format&fit=crop'" class="w-full h-full object-cover">
                <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent"></div>
                
                <!-- Title & Countdown -->
                <div class="absolute bottom-20 left-6 text-white">
                    <div class="flex items-end mb-1">
                        <h1 class="text-3xl font-bold tracking-wide drop-shadow-md mr-3">ä¹å·å†’éšª</h1>
                        <!-- Countdown Badge -->
                        <div v-if="daysUntilTrip > 0" class="bg-kuma-red px-2 py-0.5 rounded-lg text-xs font-bold animate-bounce-slow mb-2 shadow-lg">
                            é‚„æœ‰ {{ daysUntilTrip }} å¤©å‡ºç™¼ ğŸš€
                        </div>
                        <div v-else-if="daysUntilTrip <= 0 && daysUntilTrip > -8" class="bg-aso-green px-2 py-0.5 rounded-lg text-xs font-bold mb-2 shadow-lg">
                            æ—…ç¨‹é€²è¡Œä¸­ ğŸš—
                        </div>
                    </div>
                    <p class="text-sm opacity-90 font-medium">ç†Šæœ¬ â€¢ é˜¿è˜‡ â€¢ åˆ¥åºœ â€¢ é«˜åƒç©—</p>
                </div>
            </div>

            <!-- Floating Tabs -->
            <div class="absolute bottom-4 right-4 flex space-x-3 z-20">
                <button v-for="tab in tabs" :key="tab.id" @click="currentTab = tab.id"
                    :class="['flex flex-col items-center justify-center w-14 h-14 rounded-2xl shadow-lg transition-all transform active:scale-95', currentTab === tab.id ? 'bg-kuma-red text-white scale-110' : 'glass-tab text-kuma-black']">
                    <i :class="tab.icon + ' text-xl mb-1'"></i>
                    <span class="text-[10px] font-bold">{{ tab.name }}</span>
                </button>
            </div>
        </header>

        <!-- ================= MAIN CONTENT ================= -->
        <main class="-mt-6 relative z-0 px-4">

            <!-- TAB 1: ITINERARY -->
            <div v-if="currentTab === 'itinerary'" class="space-y-4">
                <!-- Date Selector -->
                <div class="flex overflow-x-auto no-scrollbar space-x-3 pb-2 pt-8">
                    <div v-for="(day, index) in tripDates" :key="day.dateStr" @click="selectedDateIndex = index"
                        :class="['flex-shrink-0 flex flex-col items-center justify-center w-16 h-20 rounded-2xl border transition-all cursor-pointer', selectedDateIndex === index ? 'bg-kuma-black text-white border-kuma-black shadow-lg -translate-y-1' : 'bg-white text-gray-400 border-gray-100 shadow-sm']">
                        <span class="text-xs font-medium">{{ day.dayOfWeek }}</span>
                        <span class="text-2xl font-bold">{{ day.dayNumber }}</span>
                    </div>
                </div>

                <!-- Weather -->
                <div class="bg-gradient-to-r from-blue-400 to-blue-300 rounded-2xl p-4 text-white shadow-md flex items-center justify-between">
                    <div>
                        <div class="text-sm opacity-90">é˜¿è˜‡/ç†Šæœ¬ å¤©æ°£é å ±</div>
                        <div class="text-3xl font-bold mt-1">{{ mockWeather(selectedDateIndex).temp }}Â°C</div>
                        <div class="text-xs mt-1 opacity-80">é«”æ„Ÿ {{ mockWeather(selectedDateIndex).feelsLike }}Â°C</div>
                    </div>
                    <div class="flex flex-col items-center">
                        <i :class="mockWeather(selectedDateIndex).icon + ' text-4xl'"></i>
                        <span class="text-xs mt-1">{{ mockWeather(selectedDateIndex).desc }}</span>
                    </div>
                </div>

                <!-- AI Guide Button -->
                <button @click="askAIGuide" class="w-full bg-white border border-purple-200 text-purple-600 font-bold py-3 rounded-2xl shadow-sm flex items-center justify-center space-x-2 active:scale-98 transition-all">
                    <i class="fa-solid fa-wand-magic-sparkles text-lg"></i><span>AI éš¨èº«å°éŠï¼šåˆ†ææœ¬æ—¥è¡Œç¨‹</span>
                </button>

                <!-- Itinerary List -->
                <div class="space-y-4 pb-24">
                    <div v-if="currentDayItinerary.length === 0" class="text-center py-10 text-gray-400">
                        <i class="fa-solid fa-map-location-dot text-4xl mb-3"></i><p>æœ¬æ—¥å°šç„¡è¡Œç¨‹</p>
                    </div>
                    <div v-for="(item, index) in currentDayItinerary" :key="item.id" class="relative group">
                        <div v-if="index > 0" class="flex justify-center py-2 items-center text-xs text-gray-400 space-x-2">
                            <i :class="getTransportIcon(item.transportType)"></i><span class="border-b border-dashed border-gray-300 px-2">{{ item.transportTime || '15' }} åˆ†é˜</span><i class="fa-solid fa-arrow-down text-[10px]"></i>
                        </div>
                        <div v-else class="flex justify-center py-2 items-center text-xs text-gray-400 space-x-2">
                            <i class="fa-solid fa-hotel"></i><span class="border-b border-dashed border-gray-300 px-2">å¾é£¯åº—å‡ºç™¼</span><i class="fa-solid fa-arrow-down text-[10px]"></i>
                        </div>

                        <div @click="openMap(item.name)" :class="['bg-white rounded-2xl p-4 shadow-card border-l-4 relative overflow-hidden active:scale-98 transition-transform cursor-pointer', item.type === 'flight' ? 'border-aso-blue bg-blue-50' : item.type === 'food' ? 'border-orange-400' : item.type === 'shopping' ? 'border-pink-400' : 'border-aso-green']">
                            <div class="absolute right-2 top-2 text-gray-300"><i class="fa-solid fa-grip-lines"></i></div>
                            <div v-if="item.type === 'flight'" class="flex flex-col">
                                <div class="flex justify-between items-center mb-2"><span class="bg-blue-100 text-blue-600 text-xs px-2 py-1 rounded-full font-bold"><i class="fa-solid fa-plane-up mr-1"></i> {{ item.name }}</span><span class="text-lg font-bold text-gray-700">{{ item.time }}</span></div>
                                <div class="text-sm text-gray-600">{{ item.memo }}</div>
                            </div>
                            <div v-else class="flex items-start">
                                <div class="flex flex-col items-center mr-4 pt-1 min-w-[50px]">
                                    <span class="text-lg font-bold text-gray-800 leading-none">{{ item.time.split(':')[0] }}</span><span class="text-xs text-gray-500">{{ item.time.split(':')[1] }}</span>
                                </div>
                                <div class="flex-1">
                                    <h3 class="font-bold text-gray-800 text-lg leading-tight mb-1">{{ item.name }} <i class="fa-solid fa-location-arrow text-[10px] text-aso-blue ml-1 opacity-50"></i></h3>
                                    <div class="flex flex-wrap gap-2 text-xs text-gray-500 mb-2">
                                        <span v-if="item.hours" class="bg-gray-100 px-2 py-0.5 rounded text-gray-600"><i class="fa-regular fa-clock mr-1"></i>{{ item.hours }}</span>
                                        <span v-if="item.ticket" class="bg-yellow-50 px-2 py-0.5 rounded text-yellow-700"><i class="fa-solid fa-ticket mr-1"></i>{{ item.ticket }}</span>
                                    </div>
                                    <p v-if="item.memo" class="text-sm text-gray-600 bg-gray-50 p-2 rounded-lg border border-gray-100"><i class="fa-solid fa-circle-info text-kuma-red mr-1"></i> {{ item.memo }}</p>
                                </div>
                            </div>
                            <button @click.stop="editItem(item)" class="absolute bottom-2 right-2 p-2 text-gray-300 hover:text-gray-500 z-10"><i class="fa-solid fa-pen-to-square"></i></button>
                        </div>
                    </div>
                </div>
                <button @click="openAddModal" class="fixed bottom-24 right-6 w-14 h-14 bg-kuma-black text-white rounded-full shadow-xl flex items-center justify-center text-2xl active:scale-90 transition-transform z-30"><i class="fa-solid fa-plus"></i></button>
            </div>

            <!-- TAB 2: INFO (è³‡è¨Š + æ†‘è­‰ + æ—¥èª + ç¿»è­¯ + è‡ªé§•) -->
            <div v-else-if="currentTab === 'info'" class="space-y-6 pt-6 pb-24">
                
                <!-- Info Switcher -->
                <div class="flex p-1 bg-gray-200 rounded-xl overflow-x-auto no-scrollbar">
                    <button @click="infoMode = 'basic'" :class="['flex-1 py-2 px-3 rounded-lg text-sm font-bold transition-all whitespace-nowrap', infoMode === 'basic' ? 'bg-white shadow text-kuma-black' : 'text-gray-500']">è³‡è¨Š</button>
                    <button @click="infoMode = 'voucher'" :class="['flex-1 py-2 px-3 rounded-lg text-sm font-bold transition-all whitespace-nowrap', infoMode === 'voucher' ? 'bg-white shadow text-kuma-black' : 'text-gray-500']">ğŸ«æ†‘è­‰</button>
                    <button @click="infoMode = 'drive'" :class="['flex-1 py-2 px-3 rounded-lg text-sm font-bold transition-all whitespace-nowrap', infoMode === 'drive' ? 'bg-white shadow text-kuma-black' : 'text-gray-500']">ğŸš—è‡ªé§•</button>
                    <button @click="infoMode = 'phrase'" :class="['flex-1 py-2 px-3 rounded-lg text-sm font-bold transition-all whitespace-nowrap', infoMode === 'phrase' ? 'bg-white shadow text-kuma-black' : 'text-gray-500']">ğŸ‡¯ğŸ‡µæ—¥èª</button>
                    <button @click="infoMode = 'translate'" :class="['flex-1 py-2 px-3 rounded-lg text-sm font-bold transition-all whitespace-nowrap', infoMode === 'translate' ? 'bg-white shadow text-kuma-black' : 'text-gray-500']">AIç¿»è­¯</button>
                </div>

                <!-- Basic Info Content -->
                <div v-if="infoMode === 'basic'" class="space-y-6">
                    <div class="bg-white rounded-2xl p-5 shadow-card">
                        <h2 class="text-lg font-bold mb-3 flex items-center"><i class="fa-solid fa-coins text-yellow-500 mr-2"></i> åŒ¯ç‡æ›ç®—</h2>
                        <div class="flex items-center space-x-2 bg-gray-50 p-3 rounded-xl border border-gray-200">
                            <span class="text-gray-500 font-bold">Â¥</span>
                            <input v-model="currencyInput" type="number" placeholder="è¼¸å…¥æ—¥å¹£é‡‘é¡" class="bg-transparent w-full outline-none font-bold text-lg">
                        </div>
                        <div class="flex justify-between items-center mt-3 px-1">
                            <span class="text-xs text-gray-400">åŒ¯ç‡: {{ exchangeRate }}</span><div class="text-xl font-bold text-kuma-red">NT$ {{ calculateTWD }}</div>
                        </div>
                    </div>

                    <!-- Rent a Car Info -->
                    <div class="bg-white rounded-2xl p-5 shadow-card">
                        <h2 class="text-lg font-bold mb-3 flex items-center"><i class="fa-solid fa-car text-aso-green mr-2"></i> ç§Ÿè»Šè³‡è¨Š</h2>
                        <div class="text-sm space-y-2">
                            <div class="flex justify-between text-gray-600"><span>Toyota Rent a Car (ç†Šæœ¬ç«™å‰)</span></div>
                            <div class="bg-gray-100 p-2 rounded text-xs text-gray-600 mt-1"><i class="fa-solid fa-check text-green-500"></i> Yaris | é›ªèƒ | 3æ­²æ±½åº§</div>
                            <button @click="openMap('Toyota Rent a Car Kumamoto Station')" class="w-full mt-2 py-2 bg-aso-green text-white rounded-lg text-sm font-bold">å°èˆªå»ç§Ÿè»Šåº—</button>
                        </div>
                    </div>
                </div>

                <!-- Voucher Area (New!) -->
                <div v-else-if="infoMode === 'voucher'" class="space-y-4">
                    <div class="flex justify-between items-center px-1">
                         <div class="text-sm text-gray-500">å…± {{ hotels.length }} å¼µæ†‘è­‰</div>
                         <button @click="openHotelModal" class="bg-kuma-black text-white px-3 py-1.5 rounded-full text-xs font-bold active:scale-95 transition-transform"><i class="fa-solid fa-plus mr-1"></i>æ–°å¢</button>
                    </div>
                   
                    <div class="space-y-4">
                        <div v-for="(hotel, index) in hotels" :key="hotel.id" class="bg-white rounded-2xl shadow-card overflow-hidden border border-gray-100 relative group">
                            <!-- Platform Badge -->
                            <div :class="['absolute top-0 right-0 px-3 py-1 rounded-bl-xl text-xs font-bold text-white', hotel.platform === 'Agoda' ? 'bg-blue-600' : 'bg-teal-500']">
                                {{ hotel.platform || 'Booking' }}
                            </div>

                            <div class="p-5">
                                <h3 class="font-bold text-lg leading-tight mb-2 pr-12">{{ hotel.name }}</h3>
                                <div class="flex items-center text-xs text-gray-500 mb-3 space-x-3">
                                    <span class="bg-gray-100 px-2 py-1 rounded"><i class="fa-solid fa-calendar-check mr-1"></i>{{ hotel.checkIn }}</span>
                                    <i class="fa-solid fa-arrow-right text-gray-300"></i>
                                    <span class="bg-gray-100 px-2 py-1 rounded"><i class="fa-solid fa-calendar-xmark mr-1"></i>{{ hotel.checkOut }}</span>
                                </div>
                                <div class="bg-gray-50 rounded-xl p-3 border border-dashed border-gray-200 flex justify-between items-center mb-3">
                                    <div>
                                        <div class="text-[10px] text-gray-400 uppercase tracking-wider">Booking ID</div>
                                        <div class="font-mono font-bold text-gray-700">{{ hotel.bookingId || 'ç„¡ç·¨è™Ÿ' }}</div>
                                    </div>
                                    <button @click="copyText(hotel.bookingId)" class="text-gray-400 hover:text-kuma-black active:scale-90 transition-transform"><i class="fa-regular fa-copy"></i></button>
                                </div>
                                <div class="flex justify-between items-end">
                                    <div class="text-xs text-gray-500">
                                        <div><i class="fa-solid fa-user mr-1"></i> {{ hotel.guest }}</div>
                                        <div class="mt-1"><i class="fa-solid fa-bed mr-1"></i> {{ hotel.roomType }}</div>
                                    </div>
                                    <div class="flex space-x-2">
                                        <button @click="openMap(hotel.name)" class="w-8 h-8 rounded-full bg-blue-50 text-blue-500 flex items-center justify-center hover:bg-blue-100"><i class="fa-solid fa-location-dot"></i></button>
                                        <button @click="editHotel(hotel, index)" class="w-8 h-8 rounded-full bg-gray-100 text-gray-500 flex items-center justify-center hover:bg-gray-200"><i class="fa-solid fa-pen"></i></button>
                                        <button @click="deleteHotel(index)" class="w-8 h-8 rounded-full bg-red-50 text-red-500 flex items-center justify-center hover:bg-red-100"><i class="fa-solid fa-trash"></i></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Driver Mode Content (New!) -->
                <div v-else-if="infoMode === 'drive'" class="space-y-4 animate-pulse-once">
                    <div class="bg-white p-5 rounded-2xl shadow-card border-l-4 border-aso-green">
                        <h2 class="font-bold text-lg mb-2 text-gray-800">ğŸŒ æ—¥æœ¬é§•é§›æé†’</h2>
                        <div class="flex justify-between items-center mb-4">
                            <div class="text-center w-1/2 border-r border-gray-100">
                                <div class="text-2xl font-bold text-red-500 mb-1"><i class="fa-solid fa-turn-up fa-rotate-270"></i> å·¦è½‰</div>
                                <div class="text-xs text-gray-500">å°å½ (é å·¦)</div>
                            </div>
                            <div class="text-center w-1/2">
                                <div class="text-2xl font-bold text-blue-500 mb-1"><i class="fa-solid fa-turn-up fa-rotate-90"></i> å³è½‰</div>
                                <div class="text-xs text-gray-500">å¤§å½ (è·¨è»Šé“)</div>
                            </div>
                        </div>
                        <div class="bg-red-50 text-red-600 text-xs p-2 rounded-lg">
                            <i class="fa-solid fa-circle-exclamation mr-1"></i> è¡Œäººå„ªå…ˆï¼è½‰å½è«‹å‹™å¿…ç¦®è®“æ–‘é¦¬ç·šè¡Œäººã€‚
                        </div>
                    </div>

                    <h3 class="font-bold text-gray-600 ml-1">å‘¨é‚Šä¸€éµæœå°‹</h3>
                    <div class="grid grid-cols-2 gap-3">
                        <button @click="quickSearch('gas station')" class="bg-white p-4 rounded-2xl shadow-sm flex flex-col items-center justify-center hover:bg-gray-50 active:scale-95 transition-all h-28 border-b-4 border-orange-400">
                            <i class="fa-solid fa-gas-pump text-3xl text-orange-500 mb-2"></i>
                            <span class="font-bold text-gray-700">æ‰¾åŠ æ²¹ç«™</span>
                        </button>
                        <button @click="quickSearch('parking lot')" class="bg-white p-4 rounded-2xl shadow-sm flex flex-col items-center justify-center hover:bg-gray-50 active:scale-95 transition-all h-28 border-b-4 border-blue-400">
                            <i class="fa-solid fa-square-parking text-3xl text-blue-500 mb-2"></i>
                            <span class="font-bold text-gray-700">æ‰¾åœè»Šå ´</span>
                        </button>
                        <button @click="quickSearch('convenience store')" class="bg-white p-4 rounded-2xl shadow-sm flex flex-col items-center justify-center hover:bg-gray-50 active:scale-95 transition-all h-28 border-b-4 border-green-400">
                            <i class="fa-solid fa-store text-3xl text-green-500 mb-2"></i>
                            <span class="font-bold text-gray-700">ä¾¿åˆ©å•†åº—</span>
                        </button>
                        <button @click="quickSearch('public toilet')" class="bg-white p-4 rounded-2xl shadow-sm flex flex-col items-center justify-center hover:bg-gray-50 active:scale-95 transition-all h-28 border-b-4 border-purple-400">
                            <i class="fa-solid fa-restroom text-3xl text-purple-500 mb-2"></i>
                            <span class="font-bold text-gray-700">æ‰¾å»æ‰€</span>
                        </button>
                    </div>
                     <button @click="quickSearch('Michi-no-Eki')" class="w-full bg-white p-4 rounded-2xl shadow-sm flex items-center justify-center hover:bg-gray-50 active:scale-95 transition-all border-b-4 border-yellow-400">
                        <i class="fa-solid fa-mug-hot text-xl text-yellow-500 mr-2"></i>
                        <span class="font-bold text-gray-700">æœå°‹é“ã®é§… (ä¼‘æ¯ç«™)</span>
                    </button>
                </div>

                <!-- Japanese Phrases Content (Expanded + Audio) -->
                <div v-else-if="infoMode === 'phrase'" class="space-y-4">
                     <!-- Category Filter -->
                     <div class="flex space-x-2 overflow-x-auto no-scrollbar pb-1">
                        <button v-for="cat in phraseCategories" :key="cat" @click="selectedPhraseCat = cat"
                            :class="['px-3 py-1 rounded-full text-xs font-bold whitespace-nowrap', selectedPhraseCat === cat ? 'bg-kuma-black text-white' : 'bg-gray-200 text-gray-600']">
                            {{ cat }}
                        </button>
                    </div>

                    <!-- Phrase Cards -->
                    <div class="grid grid-cols-1 gap-3">
                        <div v-for="(p, idx) in filteredPhrases" :key="idx" @click="showBigText(p)" class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 active:bg-gray-50 cursor-pointer relative group">
                            <div class="flex justify-between items-start">
                                <div>
                                    <div class="text-xs text-gray-500 mb-1">{{ p.zh }}</div>
                                    <div class="text-lg font-bold text-gray-800">{{ p.jp }}</div>
                                    <div class="text-xs text-gray-400 mt-1 font-mono">{{ p.ro }}</div>
                                </div>
                                <button @click.stop="speak(p.jp)" class="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center text-aso-blue active:bg-aso-blue active:text-white transition-colors">
                                    <i class="fa-solid fa-volume-high"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI Translator Content (New: With Smart Voice Support) -->
                <div v-else class="space-y-4">
                    <div class="bg-white p-5 rounded-2xl shadow-card">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-bold text-lg"><i class="fa-solid fa-language text-purple-500 mr-2"></i>é›™å‘ç¿»è­¯</h3>
                            <span class="text-xs text-gray-400 bg-gray-100 px-2 py-1 rounded">æ”¯æ´èªéŸ³è¼¸å…¥</span>
                        </div>
                        
                        <textarea v-model="transInput" class="w-full h-24 bg-gray-50 p-3 rounded-xl border border-gray-200 mb-3 resize-none" :placeholder="isSpeechSupported ? 'è¼¸å…¥æ–‡å­—æˆ–ä½¿ç”¨ä¸‹æ–¹èªéŸ³æŒ‰éˆ•...' : 'é»æ“Šæ­¤è™•ï¼Œä½¿ç”¨éµç›¤ä¸Šçš„éº¥å…‹é¢¨è¼¸å…¥...'"></textarea>
                        
                        <!-- Voice Input Buttons (Conditional Rendering) -->
                        <div v-if="isSpeechSupported" class="grid grid-cols-2 gap-3 mb-3">
                            <button 
                                @click="startListening('zh-TW')" 
                                :class="['py-3 rounded-xl font-bold flex items-center justify-center transition-all', isListening && currentListenLang === 'zh-TW' ? 'bg-red-500 text-white recording-ring' : 'bg-gray-100 text-gray-700 hover:bg-gray-200']"
                            >
                                <i class="fa-solid fa-microphone mr-2"></i> ğŸ‡¹ğŸ‡¼ èªªä¸­æ–‡
                            </button>
                            <button 
                                @click="startListening('ja-JP')" 
                                :class="['py-3 rounded-xl font-bold flex items-center justify-center transition-all', isListening && currentListenLang === 'ja-JP' ? 'bg-red-500 text-white recording-ring' : 'bg-gray-100 text-gray-700 hover:bg-gray-200']"
                            >
                                <i class="fa-solid fa-microphone mr-2"></i> ğŸ‡¯ğŸ‡µ èªªæ—¥æ–‡
                            </button>
                        </div>
                        
                        <!-- iOS/Unsupported Fallback Tip -->
                        <div v-else class="bg-yellow-50 text-yellow-700 p-3 rounded-xl mb-3 text-sm flex items-center border border-yellow-100">
                            <i class="fa-solid fa-lightbulb text-yellow-500 mr-3 text-lg"></i>
                            <div>
                                <div class="font-bold">iOS ç”¨æˆ¶å°æ’‡æ­¥</div>
                                <div class="text-xs opacity-80 mt-1">è˜‹æœå°šæœªé–‹æ”¾ç¶²é èªéŸ³æŒ‰éˆ•ï¼Œè«‹ç›´æ¥é»æ“Šä¸Šæ–¹è¼¸å…¥æ¡†ï¼Œä½¿ç”¨éµç›¤ä¸Šçš„ã€Œéº¥å…‹é¢¨ã€è¼¸å…¥å–”ï¼ğŸ™ï¸</div>
                            </div>
                        </div>

                        <button @click="handleTranslation" :disabled="isTranslating || !transInput" class="w-full bg-kuma-black text-white py-3 rounded-xl font-bold flex items-center justify-center disabled:opacity-50">
                            <span v-if="isTranslating"><i class="fa-solid fa-circle-notch fa-spin mr-2"></i>ç¿»è­¯ä¸­...</span>
                            <span v-else>é–‹å§‹ç¿»è­¯</span>
                        </button>

                        <!-- Result -->
                        <div v-if="transResult" class="mt-4 pt-4 border-t border-gray-100 animate-pulse-once">
                            <div class="flex justify-between items-start">
                                <div class="text-lg font-bold text-gray-800">{{ transResult }}</div>
                                <button @click="speak(transResult)" class="text-aso-blue p-2 active:scale-90 transition-transform"><i class="fa-solid fa-volume-high text-xl"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB 3: SHOPPING -->
            <div v-else-if="currentTab === 'shopping'" class="space-y-4 pt-6 pb-24">
                <div class="bg-white p-4 rounded-2xl shadow-card">
                    <div class="text-sm font-bold text-gray-600 mb-2">å¿«é€Ÿæ–°å¢æ¨è–¦æ¸…å–®</div>
                    <div class="flex space-x-2 overflow-x-auto no-scrollbar mb-3">
                        <button v-for="cat in Object.keys(presetShoppingItems)" :key="cat" @click="selectedPresetCategory = cat"
                            :class="['px-3 py-1 rounded-full text-xs font-bold whitespace-nowrap transition-colors', selectedPresetCategory === cat ? 'bg-pink-500 text-white' : 'bg-gray-100 text-gray-500']">
                            {{ cat }}
                        </button>
                    </div>
                    <div class="flex flex-wrap gap-2">
                        <button v-for="item in presetShoppingItems[selectedPresetCategory]" :key="item" @click="addPresetItem(item)"
                            class="bg-pink-50 text-pink-600 px-3 py-1.5 rounded-lg text-xs font-medium border border-pink-100 active:scale-95 transition-transform flex items-center">
                            <i class="fa-solid fa-plus mr-1"></i> {{ item }}
                        </button>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-2xl shadow-card flex items-center justify-between">
                    <h2 class="font-bold text-xl">è³¼ç‰©æ¸…å–®</h2><span class="text-xs bg-gray-100 px-2 py-1 rounded-full text-gray-500">{{ shoppingList.length }} é …</span>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div v-for="(item, index) in shoppingList" :key="index" @click="editShoppingItem(item, index)" class="bg-white rounded-xl shadow-sm overflow-hidden relative group active:scale-98 transition-transform cursor-pointer">
                        <div class="h-32 bg-gray-100 flex items-center justify-center overflow-hidden">
                            <img v-if="item.image" :src="item.image" class="w-full h-full object-cover">
                            <i v-else class="fa-solid fa-image text-gray-300 text-3xl"></i>
                        </div>
                        <div class="p-3">
                            <h3 class="font-bold text-sm truncate">{{ item.name }}</h3>
                            <div class="flex justify-between items-center mt-2">
                                <span class="text-[10px] bg-gray-100 text-gray-500 px-1.5 py-0.5 rounded">ç·¨è¼¯</span>
                                <button @click.stop="deleteShoppingItem(index)" class="text-xs text-red-400 p-1"><i class="fa-solid fa-trash"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
                <button @click="openShoppingModal" class="fixed bottom-24 right-6 w-14 h-14 bg-pink-500 text-white rounded-full shadow-xl flex items-center justify-center text-2xl active:scale-90 transition-transform z-30"><i class="fa-solid fa-cart-plus"></i></button>
            </div>

            <!-- TAB 4: EXPENSES -->
            <div v-else-if="currentTab === 'expenses'" class="space-y-4 pt-6 pb-24">
                <div class="bg-kuma-black text-white rounded-2xl p-6 shadow-card">
                    <div class="text-sm opacity-70 mb-1">ç¸½èŠ±è²» (JPY)</div>
                    <div class="text-4xl font-bold">Â¥{{ totalExpenses.toLocaleString() }}</div>
                    <div class="mt-4 flex space-x-2 overflow-x-auto text-xs">
                        <span class="bg-gray-800 px-3 py-1 rounded-full">é£²é£Ÿ Â¥{{ expensesByCategory.food.toLocaleString() }}</span>
                        <span class="bg-gray-800 px-3 py-1 rounded-full">è³¼ç‰© Â¥{{ expensesByCategory.shopping.toLocaleString() }}</span>
                        <span class="bg-gray-800 px-3 py-1 rounded-full">äº¤é€š Â¥{{ expensesByCategory.transport.toLocaleString() }}</span>
                    </div>
                </div>
                <div class="bg-white rounded-2xl shadow-card overflow-hidden">
                    <div v-if="expenseList.length === 0" class="p-8 text-center text-gray-400 text-sm">å°šæœªæ–°å¢ç´€éŒ„</div>
                    <div v-for="(exp, index) in expenseList" :key="index" class="p-4 border-b border-gray-100 flex justify-between items-center last:border-0">
                        <div class="flex items-center">
                            <div :class="['w-10 h-10 rounded-full flex items-center justify-center text-white mr-3', getCategoryColor(exp.category)]"><i :class="getCategoryIcon(exp.category)"></i></div>
                            <div><div class="font-bold text-sm">{{ exp.name }}</div><div class="text-xs text-gray-400">{{ exp.date }} Â· {{ exp.payment }}</div></div>
                        </div>
                        <div class="font-bold text-gray-800">Â¥{{ parseInt(exp.amount).toLocaleString() }}</div>
                        <button @click="deleteExpense(index)" class="ml-2 text-gray-300 hover:text-red-400"><i class="fa-solid fa-xmark"></i></button>
                    </div>
                </div>
                <button @click="openExpenseModal" class="fixed bottom-24 right-6 w-14 h-14 bg-yellow-500 text-white rounded-full shadow-xl flex items-center justify-center text-2xl active:scale-90 transition-transform z-30"><i class="fa-solid fa-yen-sign"></i></button>
            </div>
        </main>

        <!-- ================= MODALS ================= -->
        
        <!-- Big Text Modal for Phrases -->
        <div v-if="showBigTextModal" class="fixed inset-0 bg-black/90 z-50 flex flex-col items-center justify-center p-4" @click="showBigTextModal = false">
            <div class="text-white text-center w-full max-w-sm" @click.stop>
                <div class="text-sm opacity-70 mb-4">è«‹å‡ºç¤ºæ­¤ç•«é¢çµ¦åº—å“¡çœ‹</div>
                <div class="text-4xl font-bold leading-relaxed bg-white text-black p-6 rounded-2xl break-words">{{ bigTextContent }}</div>
                <div class="text-lg mt-4 text-gray-300">{{ bigTextSub }}</div>
                
                <button @click="speak(bigTextContent)" class="mt-6 w-16 h-16 bg-blue-500 rounded-full flex items-center justify-center text-white text-2xl shadow-lg mx-auto active:scale-95 transition-transform">
                    <i class="fa-solid fa-volume-high"></i>
                </button>
                
                <div class="mt-8 text-sm opacity-50 cursor-pointer" @click="showBigTextModal = false">é»æ“Šä»»æ„è™•é—œé–‰</div>
            </div>
        </div>

        <!-- Settings Modal (Expanded with Backup) -->
        <div v-if="showSettingsModal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl w-full max-w-sm p-5 max-h-[90vh] overflow-y-auto">
                <h3 class="text-xl font-bold mb-4">è¨­å®š</h3>
                <div class="mb-5">
                    <label class="text-xs font-bold text-gray-500 block mb-1">Gemini API Key</label>
                    <input v-model="userApiKey" type="password" class="w-full bg-gray-100 p-3 rounded-lg text-sm" placeholder="è²¼ä¸Šæ‚¨çš„ API Key">
                </div>

                <div class="mb-5 border-t border-gray-100 pt-4">
                    <label class="text-xs font-bold text-gray-500 block mb-2">è³‡æ–™å‚™ä»½èˆ‡è½‰ç§»</label>
                    <div class="grid grid-cols-2 gap-2">
                        <button @click="exportData" class="bg-blue-50 text-blue-600 py-2 rounded-lg text-sm font-bold border border-blue-100"><i class="fa-solid fa-file-export mr-1"></i> åŒ¯å‡ºè³‡æ–™</button>
                        <button @click="showImport = !showImport" class="bg-green-50 text-green-600 py-2 rounded-lg text-sm font-bold border border-green-100"><i class="fa-solid fa-file-import mr-1"></i> åŒ¯å…¥è³‡æ–™</button>
                    </div>
                    <div v-if="showImport" class="mt-2">
                        <textarea v-model="importString" class="w-full h-20 bg-gray-50 p-2 rounded-lg text-xs border border-gray-200" placeholder="åœ¨æ­¤è²¼ä¸Šå‚™ä»½ä»£ç¢¼..."></textarea>
                        <button @click="importData" class="w-full mt-2 bg-green-600 text-white py-2 rounded-lg text-sm font-bold">ç¢ºèªåŒ¯å…¥</button>
                    </div>
                </div>

                <div class="flex gap-2"><button @click="saveSettings" class="flex-1 bg-kuma-black text-white py-3 rounded-xl font-bold">å„²å­˜ä¸¦é—œé–‰</button></div>
            </div>
        </div>

        <!-- AI Modal -->
        <div v-if="showAIModal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl w-full max-w-sm max-h-[80vh] overflow-y-auto p-6 relative">
                <button @click="showAIModal = false" class="absolute top-4 right-4 text-gray-400"><i class="fa-solid fa-xmark text-xl"></i></button>
                <div class="text-center mb-4"><div class="w-12 h-12 bg-purple-100 text-purple-600 rounded-full flex items-center justify-center mx-auto mb-2"><i class="fa-solid fa-wand-magic-sparkles text-xl"></i></div><h3 class="text-xl font-bold">AI éš¨èº«å°éŠ</h3></div>
                <div v-if="isAiLoading" class="text-center py-8"><i class="fa-solid fa-circle-notch fa-spin text-4xl text-purple-500 mb-4"></i><p class="text-gray-500 animate-pulse">åˆ†æè¡Œç¨‹ä¸­...</p></div>
                <div v-else class="ai-response text-sm text-gray-700 leading-relaxed" v-html="aiResponse"></div>
                <button v-if="!isAiLoading" @click="showAIModal = false" class="w-full mt-6 bg-purple-600 text-white py-3 rounded-xl font-bold">çŸ¥é“äº†</button>
            </div>
        </div>

        <!-- Itinerary Edit Modal -->
        <div v-if="showItineraryModal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl w-full max-w-sm max-h-[90vh] overflow-y-auto p-5">
                <h3 class="text-xl font-bold mb-4">{{ isEditing ? 'ç·¨è¼¯è¡Œç¨‹' : 'æ–°å¢è¡Œç¨‹' }}</h3>
                <div class="space-y-3">
                    <div><label class="text-xs font-bold text-gray-500">åç¨±</label><input v-model="formItinerary.name" class="w-full bg-gray-100 p-2 rounded-lg"></div>
                    <div class="grid grid-cols-2 gap-2">
                        <div><label class="text-xs font-bold text-gray-500">åˆ†é¡</label><select v-model="formItinerary.type" class="w-full bg-gray-100 p-2 rounded-lg"><option value="sight">æ™¯é»</option><option value="food">ç¾é£Ÿ</option><option value="shopping">è³¼ç‰©</option><option value="hotel">ä½å®¿</option><option value="other">å…¶ä»–</option></select></div>
                        <div><label class="text-xs font-bold text-gray-500">æ™‚é–“</label><input type="time" v-model="formItinerary.time" class="w-full bg-gray-100 p-2 rounded-lg"></div>
                    </div>
                    <div><label class="text-xs font-bold text-gray-500">äº¤é€š (åˆ°æ­¤åœ°)</label><div class="flex space-x-2 mt-1"><button @click="formItinerary.transportType = 'car'" :class="['flex-1 py-2 rounded-lg text-sm', formItinerary.transportType === 'car' ? 'bg-kuma-black text-white' : 'bg-gray-100']"><i class="fa-solid fa-car"></i></button><button @click="formItinerary.transportType = 'walk'" :class="['flex-1 py-2 rounded-lg text-sm', formItinerary.transportType === 'walk' ? 'bg-kuma-black text-white' : 'bg-gray-100']"><i class="fa-solid fa-person-walking"></i></button><button @click="formItinerary.transportType = 'public'" :class="['flex-1 py-2 rounded-lg text-sm', formItinerary.transportType === 'public' ? 'bg-kuma-black text-white' : 'bg-gray-100']"><i class="fa-solid fa-bus"></i></button></div></div>
                    <div><label class="text-xs font-bold text-gray-500">äº¤é€šæ™‚é–“ (åˆ†)</label><input type="number" v-model="formItinerary.transportTime" class="w-full bg-gray-100 p-2 rounded-lg"></div>
                    <div v-if="formItinerary.type !== 'flight'"><label class="text-xs font-bold text-gray-500">å‚™è¨»</label><textarea v-model="formItinerary.memo" class="w-full bg-gray-100 p-2 rounded-lg h-20"></textarea></div>
                    <div v-if="formItinerary.type === 'sight'"><label class="text-xs font-bold text-gray-500">é–€ç¥¨</label><input v-model="formItinerary.ticket" class="w-full bg-gray-100 p-2 rounded-lg"></div>
                </div>
                <div class="flex gap-2 mt-6"><button v-if="isEditing" @click="confirmDeleteItinerary" class="flex-1 bg-red-100 text-red-500 py-3 rounded-xl font-bold">åˆªé™¤</button><button @click="saveItinerary" class="flex-1 bg-kuma-black text-white py-3 rounded-xl font-bold">å„²å­˜</button><button @click="showItineraryModal = false" class="px-4 py-3 text-gray-400">å–æ¶ˆ</button></div>
            </div>
        </div>

        <!-- Hotel Edit Modal -->
        <div v-if="showHotelModal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
             <div class="bg-white rounded-2xl w-full max-w-sm p-5 max-h-[90vh] overflow-y-auto">
                <h3 class="text-xl font-bold mb-4">{{ isEditingHotel ? 'ç·¨è¼¯æ†‘è­‰' : 'æ–°å¢æ†‘è­‰' }}</h3>
                <div class="space-y-3">
                    <div>
                        <label class="text-xs font-bold text-gray-500">é è¨‚å¹³å°</label>
                        <div class="flex space-x-2 mt-1">
                            <button @click="formHotel.platform = 'Agoda'" :class="['flex-1 py-2 rounded-lg text-sm font-bold border', formHotel.platform === 'Agoda' ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-gray-500 border-gray-200']">Agoda</button>
                            <button @click="formHotel.platform = 'KKday'" :class="['flex-1 py-2 rounded-lg text-sm font-bold border', formHotel.platform === 'KKday' ? 'bg-teal-500 text-white border-teal-500' : 'bg-white text-gray-500 border-gray-200']">KKday</button>
                            <button @click="formHotel.platform = 'Booking'" :class="['flex-1 py-2 rounded-lg text-sm font-bold border', formHotel.platform === 'Booking' ? 'bg-blue-800 text-white border-blue-800' : 'bg-white text-gray-500 border-gray-200']">Booking</button>
                        </div>
                    </div>
                    <div><label class="text-xs font-bold text-gray-500">é£¯åº—åç¨±</label><input v-model="formHotel.name" class="w-full bg-gray-100 p-3 rounded-lg text-sm font-bold"></div>
                    <div class="grid grid-cols-2 gap-2">
                        <div><label class="text-xs font-bold text-gray-500">å…¥ä½ (Check-in)</label><input type="date" v-model="formHotel.checkIn" class="w-full bg-gray-100 p-2 rounded-lg text-sm"></div>
                        <div><label class="text-xs font-bold text-gray-500">é€€æˆ¿ (Check-out)</label><input type="date" v-model="formHotel.checkOut" class="w-full bg-gray-100 p-2 rounded-lg text-sm"></div>
                    </div>
                    <div><label class="text-xs font-bold text-gray-500">è¨‚å–®ç·¨è™Ÿ (Booking ID)</label><input v-model="formHotel.bookingId" class="w-full bg-gray-100 p-3 rounded-lg text-sm font-mono" placeholder="Check-in æ™‚ä½¿ç”¨"></div>
                    <div><label class="text-xs font-bold text-gray-500">æˆ¿å‹</label><input v-model="formHotel.roomType" class="w-full bg-gray-100 p-2 rounded-lg text-sm"></div>
                    <div><label class="text-xs font-bold text-gray-500">ä½å®¢å§“å</label><input v-model="formHotel.guest" class="w-full bg-gray-100 p-2 rounded-lg text-sm"></div>
                </div>
                <div class="flex gap-2 mt-6"><button @click="saveHotel" class="flex-1 bg-kuma-black text-white py-3 rounded-xl font-bold">å„²å­˜</button><button @click="showHotelModal = false" class="px-4 py-3 text-gray-400">å–æ¶ˆ</button></div>
             </div>
        </div>

        <!-- Shopping Modal -->
        <div v-if="showShoppingModal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
             <div class="bg-white rounded-2xl w-full max-w-sm p-5">
                <h3 class="text-xl font-bold mb-4">{{ isEditingShopping ? 'ç·¨è¼¯å•†å“' : 'æ–°å¢å•†å“' }}</h3>
                <input v-model="formShopping.name" class="w-full bg-gray-100 p-3 rounded-lg mb-3" placeholder="å•†å“åç¨±">
                <label class="block w-full h-32 bg-gray-100 rounded-lg flex flex-col items-center justify-center cursor-pointer text-gray-400 border-2 border-dashed border-gray-300 relative overflow-hidden">
                    <div v-if="!formShopping.image" class="flex flex-col items-center pointer-events-none"><i class="fa-solid fa-camera text-2xl mb-2"></i><span class="text-xs">é»æ“Šä¸Šå‚³</span></div>
                    <input type="file" @change="handleImageUpload" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" accept="image/*">
                    <img v-if="formShopping.image" :src="formShopping.image" class="w-full h-full object-cover pointer-events-none">
                </label>
                <div class="flex gap-2 mt-4"><button @click="saveShoppingItem" class="flex-1 bg-pink-500 text-white py-3 rounded-xl font-bold">å„²å­˜</button><button @click="showShoppingModal = false" class="px-4 py-3 text-gray-400">å–æ¶ˆ</button></div>
             </div>
        </div>

        <!-- Expense Modal -->
        <div v-if="showExpenseModal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl w-full max-w-sm p-5">
               <h3 class="text-xl font-bold mb-4">è¨˜å¸³</h3>
               <div class="mb-4">
                   <label class="w-full bg-gradient-to-r from-purple-500 to-indigo-500 text-white py-3 rounded-xl font-bold flex items-center justify-center cursor-pointer shadow-md">
                       <i class="fa-solid fa-camera mr-2" :class="{'fa-spin': isScannerLoading}"></i><span>{{ isScannerLoading ? 'AI è¾¨è­˜ä¸­...' : 'âœ¨ AI æƒææ”¶æ“š' }}</span>
                       <input type="file" class="hidden" accept="image/*" @change="handleReceiptScan" :disabled="isScannerLoading">
                   </label>
               </div>
               <div class="space-y-3 relative">
                   <div v-if="isScannerLoading" class="absolute inset-0 bg-white/80 z-10 flex flex-col items-center justify-center rounded-lg"><p class="text-purple-600 font-bold animate-pulse">Gemini è®€å–ä¸­...</p></div>
                   <select v-model="formExpense.category" class="w-full bg-gray-100 p-3 rounded-lg"><option value="food">é£²é£Ÿ</option><option value="transport">äº¤é€š</option><option value="shopping">è³¼ç‰©</option><option value="hotel">ä½å®¿</option><option value="ticket">é–€ç¥¨</option><option value="other">å…¶ä»–</option></select>
                   <input v-model="formExpense.name" class="w-full bg-gray-100 p-3 rounded-lg" placeholder="åç¨±">
                   <input type="number" v-model="formExpense.amount" class="w-full bg-gray-100 p-3 rounded-lg" placeholder="é‡‘é¡ (JPY)">
                   <div class="flex space-x-2"><button @click="formExpense.payment = 'cash'" :class="['flex-1 py-2 rounded-lg text-sm', formExpense.payment === 'cash' ? 'bg-yellow-500 text-white' : 'bg-gray-100']">ç¾é‡‘</button><button @click="formExpense.payment = 'card'" :class="['flex-1 py-2 rounded-lg text-sm', formExpense.payment === 'card' ? 'bg-blue-500 text-white' : 'bg-gray-100']">ä¿¡ç”¨å¡</button></div>
               </div>
               <div class="flex gap-2 mt-6"><button @click="saveExpense" class="flex-1 bg-yellow-500 text-white py-3 rounded-xl font-bold">å„²å­˜</button><button @click="showExpenseModal = false" class="px-4 py-3 text-gray-400">å–æ¶ˆ</button></div>
            </div>
       </div>
    </div>

    <!-- JS Logic -->
    <script>
        const { createApp, ref, computed, onMounted } = Vue;
        const GEMINI_MODEL = "gemini-2.5-flash-preview-09-2025";
        // Restore API Key for iPhone/New Devices (default fallback)
        const getApiKey = () => localStorage.getItem('gemini_api_key') || "AIzaSyCETuEdHWy-jul-p4FMDb8F0vq1gSQwZIo"; 

        const callGemini = async (prompt) => {
            const key = getApiKey();
            if (!key) return "è«‹é»æ“Šå³ä¸Šè§’è¨­å®šåœ–ç¤ºï¼Œè¼¸å…¥ API Key æ‰èƒ½ä½¿ç”¨å–”ï¼";
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${key}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await response.json();
                if (data.error) throw new Error(data.error.message);
                return data.candidates?.[0]?.content?.parts?.[0]?.text;
            } catch (error) { return `éŒ¯èª¤ï¼š${error.message}`; }
        };

        const callGeminiVision = async (prompt, base64Image) => {
            const key = getApiKey();
            if (!key) { alert("è«‹è¼¸å…¥ API Key"); throw new Error("Missing Key"); }
            try {
                const base64Data = base64Image.split(',')[1];
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${key}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }, { inline_data: { mime_type: "image/jpeg", data: base64Data } }] }] })
                });
                const data = await response.json();
                if (data.error) throw new Error(data.error.message);
                return data.candidates?.[0]?.content?.parts?.[0]?.text;
            } catch (error) { alert(`æƒæå¤±æ•—ï¼š${error.message}`); return null; }
        };

        createApp({
            setup() {
                const currentTab = ref('itinerary');
                const selectedDateIndex = ref(0);
                const infoMode = ref('basic'); // 'basic', 'phrase', 'translate', 'drive', 'voucher'
                const userApiKey = ref(localStorage.getItem('gemini_api_key') || 'AIzaSyCETuEdHWy-jul-p4FMDb8F0vq1gSQwZIo');
                
                // Modals
                const showItineraryModal = ref(false);
                const showShoppingModal = ref(false);
                const showExpenseModal = ref(false);
                const showAIModal = ref(false);
                const showSettingsModal = ref(false);
                const showBigTextModal = ref(false);
                const showHotelModal = ref(false);
                const bigTextContent = ref('');
                const bigTextSub = ref('');

                // Translator States
                const transInput = ref('');
                const transResult = ref('');
                const isTranslating = ref(false);
                const isListening = ref(false);
                const currentListenLang = ref('');
                
                // iOS Detection for Voice Support
                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
                const isSpeechSupported = ref(!isIOS && ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window));

                // Settings & Data Management
                const showImport = ref(false);
                const importString = ref('');

                // Data
                const tripDates = [
                    { dateStr: '2025-02-10', dayOfWeek: 'Tue', dayNumber: '10' }, { dateStr: '2025-02-11', dayOfWeek: 'Wed', dayNumber: '11' },
                    { dateStr: '2025-02-12', dayOfWeek: 'Thu', dayNumber: '12' }, { dateStr: '2025-02-13', dayOfWeek: 'Fri', dayNumber: '13' },
                    { dateStr: '2025-02-14', dayOfWeek: 'Sat', dayNumber: '14' }, { dateStr: '2025-02-15', dayOfWeek: 'Sun', dayNumber: '15' },
                    { dateStr: '2025-02-16', dayOfWeek: 'Mon', dayNumber: '16' }, { dateStr: '2025-02-17', dayOfWeek: 'Tue', dayNumber: '17' }
                ];
                
                // Updated Hotels Data Structure
                const defaultHotels = [
                    { id: 1, name: 'ONE STATION HOTEL KUMAMOTO', checkIn: '2026-02-10', checkOut: '2026-02-11', platform: 'Agoda', bookingId: '6490683880', roomType: 'Economy Double Room', guest: 'kuan-chang chen' },
                    { id: 2, name: 'åˆ¥åºœé¾œä¹‹äº•é£¯åº— (KAMENOI HOTEL BEPPU)', checkIn: '2026-02-11', checkOut: '2026-02-13', platform: 'KKday', bookingId: '26KK205750806', roomType: 'è±ªè¯é›™åºŠæˆ¿ç„¡ç…™', guest: 'kuan-chang chen' },
                    { id: 3, name: 'é¾œä¹‹äº•é…’åº— é˜¿è˜‡ å…¬åœ’åº¦å‡æ‘', checkIn: '2026-02-13', checkOut: '2026-02-15', platform: 'KKday', bookingId: '26KK202750556', roomType: 'æ—¥å¼å®¢æˆ¿A(æœ¬é¤¨)', guest: 'kuan-chang chen' },
                    { id: 4, name: 'CANDEO HOTELSç†Šæœ¬æ–°å¸‚è¡—', checkIn: '2026-02-15', checkOut: '2026-02-17', platform: 'KKday', bookingId: '26KK200850826', roomType: 'ç‰¹å¤§æˆ¿ - ç¦è¸', guest: 'kuan-chang chen' }
                ];
                
                const hotels = ref(JSON.parse(localStorage.getItem('hotels')) || defaultHotels);

                const defaultItinerary = {
                    '2025-02-10': [{ id: 1, type: 'flight', name: 'IT766 æŠµé”ç†Šæœ¬', time: '11:50', memo: '08:45 KHH å‡ºç™¼', transportType: 'plane' }, { id: 2, type: 'hotel', name: 'ONE STATION Check-in', time: '13:30', memo: 'é£¯åº—å…¥ä½', transportType: 'public', transportTime: 40 }, { id: 3, type: 'shopping', name: 'ä¸‹é€šå•†åº—è¡—', time: '14:30', memo: 'æ¡è²·å‚™å“', transportType: 'walk', transportTime: 10 }, { id: 4, type: 'sight', name: 'ç†Šæœ¬ç†Šå»£å ´', time: '16:00', memo: 'çœ‹è¡¨æ¼”', transportType: 'walk', transportTime: 10 }, { id: 5, type: 'food', name: 'è»Šç«™å•†å ´é¤å»³', time: '18:30', memo: 'æ™šé¤', transportType: 'public', transportTime: 15 }],
                    '2025-02-11': [{ id: 6, type: 'other', name: 'ç†Šæœ¬å–è»Š', time: '09:00', memo: 'ç†Šæœ¬ç«™å‰åº— (Toyota)', transportType: 'walk', transportTime: 10 }, { id: 7, type: 'sight', name: 'åˆ¥åºœåœ°ç„å·¡ç¦®', time: '12:30', memo: 'æµ·åœ°ç„ã€é¬¼å±±åœ°ç„', transportType: 'car', transportTime: 150 }, { id: 8, type: 'food', name: 'éµè¼ªæº«æ³‰åœ°ç„è’¸', time: '13:30', memo: 'æ¨è–¦ï¼šèŒ¶å¯®å¤§è·¯', transportType: 'walk', transportTime: 5 }, { id: 9, type: 'hotel', name: 'åˆ¥åºœé¾œä¹‹äº•', time: '16:00', memo: 'Check-in', transportType: 'car', transportTime: 15 }],
                    '2025-02-12': [{ id: 10, type: 'sight', name: 'ä¹å·é‡ç”Ÿå‹•ç‰©åœ’', time: '09:30', memo: '15:00 å¢æ—å·´å£«(å·²é ç´„)', transportType: 'car', transportTime: 30 }, { id: 11, type: 'food', name: 'åˆ¥åºœå†·éºµ', time: '12:30', memo: 'åˆé¤', transportType: 'car', transportTime: 20 }, { id: 12, type: 'sight', name: 'å¤§åˆ†æ°´æ—é¤¨', time: '14:30', memo: 'æµ·ä¹‹åµ', transportType: 'car', transportTime: 20 }],
                    '2025-02-13': [{ id: 13, type: 'sight', name: 'å¡å¾·åˆ©å‹•ç‰©åœ’', time: '10:30', memo: '09:45 å˜—è©¦é ç´„ç›´å‡æ©Ÿ', transportType: 'car', transportTime: 60 }, { id: 14, type: 'sight', name: 'é˜¿è˜‡ç¥ç¤¾', time: '14:00', memo: 'æ°´åŸºå·¡ç¦®', transportType: 'car', transportTime: 15 }, { id: 15, type: 'hotel', name: 'é˜¿è˜‡é¾œä¹‹äº•', time: '16:00', memo: 'Check-in', transportType: 'car', transportTime: 20 }],
                    '2025-02-14': [{ id: 16, type: 'sight', name: 'è‰åƒé‡Œ', time: '09:30', memo: 'é›ªåœ°ç©è€(éœ€é›ªèƒ)', transportType: 'car', transportTime: 30 }, { id: 17, type: 'sight', name: 'é˜¿è˜‡ç«å±±åšç‰©é¤¨', time: '11:00', memo: 'æ›¿ä»£æ–¹æ¡ˆ', transportType: 'car', transportTime: 5 }, { id: 18, type: 'food', name: 'ã„ã¾ãã‚“é£Ÿå ‚', time: '12:30', memo: 'èµ¤ç‰›ä¸¼', transportType: 'car', transportTime: 20 }, { id: 19, type: 'sight', name: 'å¤§è§€å³°', time: '14:30', memo: 'ä¿¯ç°é˜¿è˜‡äº”å²³', transportType: 'car', transportTime: 20 }, { id: 20, type: 'other', name: 'å‰å¾€é«˜åƒç©—', time: '16:00', memo: 'è»Šç¨‹ç´„1å°æ™‚', transportType: 'car', transportTime: 60 }],
                    '2025-02-15': [{ id: 21, type: 'food', name: 'åƒç©—ä¹‹å®¶', time: '11:30', memo: 'æµæ°´éºµ', transportType: 'car', transportTime: 10 }, { id: 22, type: 'sight', name: 'é«˜åƒç©—å³½åˆ’èˆ¹', time: '13:30', memo: 'éœ€æ¶ç¥¨', transportType: 'walk', transportTime: 10 }, { id: 23, type: 'sight', name: 'å¤©å®‰æ²³åŸ', time: '15:30', memo: 'ç–ŠçŸ³è¨±é¡˜', transportType: 'car', transportTime: 15 }, { id: 24, type: 'other', name: 'ç†Šæœ¬ç«™é‚„è»Š', time: '18:00', memo: 'Toyotaé‚„è»Š', transportType: 'car', transportTime: 120 }, { id: 25, type: 'hotel', name: 'CANDEO HOTEL', time: '19:00', memo: 'Check-in', transportType: 'public', transportTime: 20 }],
                    '2025-02-16': [{ id: 26, type: 'sight', name: 'ç†Šæœ¬åŸ', time: '09:30', memo: 'åƒè§€', transportType: 'public', transportTime: 15 }, { id: 27, type: 'sight', name: 'æ«»ä¹‹é¦¬å ´', time: '11:30', memo: 'åŸå½©è‹‘', transportType: 'walk', transportTime: 10 }, { id: 28, type: 'food', name: 'å‹çƒˆäº­è±¬æ’', time: '13:00', memo: 'åˆé¤', transportType: 'walk', transportTime: 15 }, { id: 29, type: 'shopping', name: 'å¸‚å€è—¥å¦', time: '15:00', memo: 'æ¡è²·', transportType: 'walk', transportTime: 10 }, { id: 30, type: 'food', name: 'ç†Šæœ¬é»‘äº­æ‹‰éºµ', time: '18:00', memo: 'æ™šé¤', transportType: 'walk', transportTime: 10 }],
                    '2025-02-17': [{ id: 31, type: 'sight', name: 'åªäº•å·ç¶ åœ°å…¬åœ’', time: '10:00', memo: 'éŠå…·æ”¾é›»', transportType: 'public', transportTime: 30 }, { id: 32, type: 'flight', name: 'å‰å¾€æ©Ÿå ´', time: '15:30', memo: '17:50 å‰æŠµé”', transportType: 'public', transportTime: 60 }, { id: 33, type: 'flight', name: 'IT767 è¿”å°', time: '19:50', memo: '21:45 æŠµé” KHH', transportType: 'plane' }]
                };

                const phraseData = [
                    { cat: 'åŸºæœ¬', zh: 'ä½ å¥½ / æ—©å®‰', jp: 'ã“ã‚“ã«ã¡ã¯ / ãŠã¯ã‚ˆã†', ro: 'Konnichiwa / Ohayo' },
                    { cat: 'åŸºæœ¬', zh: 'è¬è¬', jp: 'ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™', ro: 'Arigatou gozaimasu' },
                    { cat: 'åŸºæœ¬', zh: 'ä¸å¥½æ„æ€ / å€Ÿé', jp: 'ã™ã¿ã¾ã›ã‚“', ro: 'Sumimasen' },
                    { cat: 'åŸºæœ¬', zh: 'æ˜¯ / ä¸æ˜¯', jp: 'ã¯ã„ / ã„ã„ãˆ', ro: 'Hai / Iie' },
                    { cat: 'åŸºæœ¬', zh: 'æˆ‘æ˜¯å°ç£äºº', jp: 'ç§ã¯å°æ¹¾äººã§ã™', ro: 'Watashi wa Taiwanjin desu' },
                    { cat: 'é¤å»³', zh: 'è«‹çµ¦æˆ‘æ°´', jp: 'ãŠæ°´ã‚’ãŠé¡˜ã„ã—ã¾ã™', ro: 'Omizu o onegai shimasu' },
                    { cat: 'é¤å»³', zh: 'è«‹çµå¸³', jp: 'ãŠä¼šè¨ˆã‚’ãŠé¡˜ã„ã—ã¾ã™', ro: 'Okaikei o onegai shimasu' },
                    { cat: 'é¤å»³', zh: 'ä¸è¦è¾£', jp: 'è¾›ãã—ãªã„ã§ãã ã•ã„', ro: 'Karaku shinaide kudasai' },
                    { cat: 'é¤å»³', zh: 'æœ‰å…’ç«¥æ¤…å—ï¼Ÿ', jp: 'å­ä¾›ç”¨ã®æ¤…å­ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ', ro: 'Kodomoyo no isu wa arimasuka?' },
                    { cat: 'é¤å»³', zh: 'å¯ä»¥åˆ·å¡å—ï¼Ÿ', jp: 'ã‚«ãƒ¼ãƒ‰ã¯ä½¿ãˆã¾ã™ã‹ï¼Ÿ', ro: 'Kado wa tsukaemasuka?' },
                    { cat: 'é¤å»³', zh: 'å¾ˆå¥½åƒ', jp: 'ã¨ã¦ã‚‚ç¾å‘³ã—ã„ã§ã™', ro: 'Totemo oishii desu' },
                    { cat: 'è‡ªé§•', zh: 'è«‹åŠ æ»¿æ²¹ (Regular)', jp: 'ãƒ¬ã‚®ãƒ¥ãƒ©ãƒ¼æº€ã‚¿ãƒ³', ro: 'Regyura mantan' },
                    { cat: 'è‡ªé§•', zh: 'é€™é™„è¿‘æœ‰åœè»Šå ´å—ï¼Ÿ', jp: 'ã“ã®è¿‘ãã«é§è»Šå ´ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ', ro: 'Konochikaku ni chushajo wa arimasuka?' },
                    { cat: 'è‡ªé§•', zh: 'å¯ä»¥åœé€™è£¡å—ï¼Ÿ', jp: 'ã“ã“ã«é§è»Šã—ã¦ã‚‚ã„ã„ã§ã™ã‹ï¼Ÿ', ro: 'Kokoni chusha shitemo iidesuka?' },
                    { cat: 'äº¤é€š', zh: 'è»Šç«™é€™å“ªè£¡ï¼Ÿ', jp: 'é§…ã¯ã©ã“ã§ã™ã‹ï¼Ÿ', ro: 'Eki wa doko desuka?' },
                    { cat: 'äº¤é€š', zh: 'é€™ç­è»Šå»åšå¤šå—ï¼Ÿ', jp: 'ã“ã®é›»è»Šã¯åšå¤šã«è¡Œãã¾ã™ã‹ï¼Ÿ', ro: 'Kono densha wa Hakata ni ikimasuka?' },
                    { cat: 'ä½å®¿', zh: 'æˆ‘æƒ³å¯„æ”¾è¡Œæ', jp: 'è·ç‰©ã‚’é ã‹ã£ã¦ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿ', ro: 'Nimotsu o azukatte itadakemasuka?' },
                    { cat: 'ä½å®¿', zh: 'Wifiå¯†ç¢¼æ˜¯å¤šå°‘ï¼Ÿ', jp: 'Wi-Fiã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯ä½•ã§ã™ã‹ï¼Ÿ', ro: 'WiFi no pasuwado wa nandesuka?' },
                    { cat: 'è³¼ç‰©', zh: 'å¯ä»¥å…ç¨…å—ï¼Ÿ', jp: 'å…ç¨ã§ãã¾ã™ã‹ï¼Ÿ', ro: 'Menzei dekimasuka?' },
                    { cat: 'è³¼ç‰©', zh: 'å¤šå°‘éŒ¢ï¼Ÿ', jp: 'ã„ãã‚‰ã§ã™ã‹ï¼Ÿ', ro: 'Ikura desuka?' },
                    { cat: 'è³¼ç‰©', zh: 'æœ‰æ–°çš„å—ï¼Ÿ', jp: 'æ–°ã—ã„ã®ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ', ro: 'Atarashii no wa arimasuka?' },
                    { cat: 'ç·Šæ€¥', zh: 'å»æ‰€åœ¨å“ªè£¡ï¼Ÿ', jp: 'ãƒˆã‚¤ãƒ¬ã¯ã©ã“ã§ã™ã‹ï¼Ÿ', ro: 'Toire wa doko desuka?' },
                    { cat: 'ç·Šæ€¥', zh: 'æˆ‘ä¸èˆ’æœ', jp: 'æ°—åˆ†ãŒæ‚ªã„ã§ã™', ro: 'Kibun ga warui desu' },
                    { cat: 'ç·Šæ€¥', zh: 'è«‹å¹«å¹«æˆ‘', jp: 'åŠ©ã‘ã¦ãã ã•ã„', ro: 'Tasukete kudasai' },
                ];

                const itineraryData = ref(JSON.parse(localStorage.getItem('itinerary')) || defaultItinerary);
                const shoppingList = ref(JSON.parse(localStorage.getItem('shopping')) || []);
                const expenseList = ref(JSON.parse(localStorage.getItem('expenses')) || []);

                // Forms
                const formItinerary = ref({});
                const formShopping = ref({ name: '', image: null });
                const formExpense = ref({ category: 'food', name: '', amount: '', payment: 'cash', date: '' });
                const formHotel = ref({ name: '', checkIn: '', checkOut: '', bookingId: '', platform: 'Agoda', roomType: '', guest: '' });
                const isEditing = ref(false);
                const isEditingShopping = ref(false);
                const isEditingHotel = ref(false);
                const editingShoppingIndex = ref(-1);
                const editingHotelIndex = ref(-1);
                const currencyInput = ref('');
                const isAiLoading = ref(false);
                const aiResponse = ref('');
                const isScannerLoading = ref(false);

                // Quick Add Logic
                const selectedPresetCategory = ref('è—¥å¦');
                const presetShoppingItems = {
                    'è—¥å¦': ['åˆåˆ©ä»–å‘½ EX', 'Wakamoto è‹¥å…ƒéŒ ', 'EVE æ­¢ç—›è—¥', 'å¤§æ­£æ„Ÿå†’è—¥', 'Chocola BB'],
                    'é›¶é£Ÿ': ['ä¸€è˜­æ‹‰éºµåŒ…', 'Calbee è–¯æ¢', 'ç™½è‰²æˆ€äºº', 'KitKat æŠ¹èŒ¶', 'å‘³è¦ºç³–'],
                    'é›»å™¨': ['Panasonic å¹é¢¨æ©Ÿ', 'Dyson å¸å¡µå™¨'], 'ä¼´æ‰‹ç¦®': ['ç†Šæœ¬ç†Šå‘¨é‚Š', 'é˜¿è˜‡ç‰›å¥¶é¤…ä¹¾', 'æ˜å¤ªå­'], 'æ¯å¬°': ['é˜¿å¡å°‡ç«¥è£', 'è²è¦ªå¥¶ç“¶', 'éºµåŒ…è¶…äººç©å…·']
                };

                // Japanese Phrase Logic
                const phraseCategories = ['åŸºæœ¬', 'é¤å»³', 'è‡ªé§•', 'äº¤é€š', 'ä½å®¿', 'è³¼ç‰©', 'ç·Šæ€¥'];
                const selectedPhraseCat = ref('åŸºæœ¬');
                const filteredPhrases = computed(() => phraseData.filter(p => p.cat === selectedPhraseCat.value));
                const showBigText = (p) => { bigTextContent.value = p.jp; bigTextSub.value = p.ro; showBigTextModal.value = true; };
                
                // Pronunciation Logic
                const speak = (text) => {
                    if ('speechSynthesis' in window) {
                        const utterance = new SpeechSynthesisUtterance(text);
                        // Simple detection: if mostly ascii/chinese -> zh-TW, if kana/kanji -> ja-JP
                        // For simplicity in this specific app context:
                        // phrases are mostly Japanese. Translation results vary.
                        // Let's guess language based on characters
                        const hasJapanese = /[\u3040-\u30ff]/.test(text);
                        utterance.lang = hasJapanese ? 'ja-JP' : 'zh-TW';
                        utterance.rate = 0.9;
                        window.speechSynthesis.speak(utterance);
                    } else {
                        alert("æ‚¨çš„è£ç½®ä¸æ”¯æ´ç™¼éŸ³åŠŸèƒ½");
                    }
                };

                // Translator Logic
                const handleTranslation = async () => {
                    if (!transInput.value) return;
                    isTranslating.value = true;
                    transResult.value = '';
                    try {
                        const prompt = `Translate the following text. If it is Chinese, translate to Japanese. If it is Japanese, translate to Traditional Chinese. Text: "${transInput.value}". Return ONLY the translated text.`;
                        const result = await callGemini(prompt);
                        transResult.value = result.trim();
                    } catch (e) {
                        alert("ç¿»è­¯å¤±æ•—ï¼Œè«‹æª¢æŸ¥ API Key æˆ–ç¶²è·¯");
                    } finally {
                        isTranslating.value = false;
                    }
                };

                // Speech Recognition Logic
                const startListening = (lang) => {
                    if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                        alert("æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¾¨è­˜åŠŸèƒ½");
                        return;
                    }
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    const recognition = new SpeechRecognition();
                    recognition.lang = lang;
                    recognition.interimResults = false;
                    recognition.maxAlternatives = 1;

                    isListening.value = true;
                    currentListenLang.value = lang;

                    recognition.onresult = (event) => {
                        const transcript = event.results[0][0].transcript;
                        transInput.value = transcript;
                        // Auto trigger translation for seamless conversation
                        handleTranslation(); 
                    };

                    recognition.onerror = (event) => {
                        console.error(event.error);
                        isListening.value = false;
                        currentListenLang.value = '';
                        // alert("èªéŸ³è¾¨è­˜å¤±æ•—ï¼Œè«‹é‡è©¦");
                    };

                    recognition.onend = () => {
                        isListening.value = false;
                        currentListenLang.value = '';
                    };

                    recognition.start();
                };

                // Countdown Logic
                const daysUntilTrip = computed(() => {
                    const today = new Date();
                    const tripStart = new Date('2025-02-10');
                    const diffTime = tripStart - today;
                    return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                });

                // Computed Basics
                const tabs = [{ id: 'itinerary', name: 'è¡Œç¨‹', icon: 'fa-solid fa-map-location-dot' }, { id: 'info', name: 'è³‡è¨Š', icon: 'fa-solid fa-circle-info' }, { id: 'shopping', name: 'è³¼ç‰©', icon: 'fa-solid fa-basket-shopping' }, { id: 'expenses', name: 'èŠ±è²»', icon: 'fa-solid fa-yen-sign' }];
                const currentDateStr = computed(() => tripDates[selectedDateIndex.value].dateStr);
                const currentDayItinerary = computed(() => (itineraryData.value[currentDateStr.value] || []).sort((a, b) => a.time.localeCompare(b.time)));
                const exchangeRate = 0.2;
                const calculateTWD = computed(() => currencyInput.value ? Math.round(currencyInput.value * exchangeRate) : 0);
                const totalExpenses = computed(() => expenseList.value.reduce((sum, item) => sum + parseInt(item.amount || 0), 0));
                const expensesByCategory = computed(() => { const cats = { food: 0, shopping: 0, transport: 0 }; expenseList.value.forEach(item => { if (cats[item.category] !== undefined) cats[item.category] += parseInt(item.amount); }); return cats; });

                // Methods
                const mockWeather = (idx) => { const w = [{ temp: 8, feelsLike: 5, icon: 'fa-solid fa-cloud-sun', desc: 'å¤šé›²' }, { temp: 6, feelsLike: 3, icon: 'fa-solid fa-cloud-rain', desc: 'å°é›¨' }, { temp: 4, feelsLike: 0, icon: 'fa-solid fa-wind', desc: 'å¼·é¢¨' }, { temp: 2, feelsLike: -2, icon: 'fa-regular fa-snowflake', desc: 'é™é›ª' }, { temp: 0, feelsLike: -4, icon: 'fa-regular fa-snowflake', desc: 'å¤§é›ª' }, { temp: 5, feelsLike: 3, icon: 'fa-solid fa-sun', desc: 'æ™´æœ—' }, { temp: 9, feelsLike: 7, icon: 'fa-solid fa-cloud', desc: 'é™°å¤©' }, { temp: 11, feelsLike: 9, icon: 'fa-solid fa-sun', desc: 'æ™´æœ—' }]; return w[idx] || w[0]; };
                const getTransportIcon = (type) => ({ car: 'fa-solid fa-car', walk: 'fa-solid fa-person-walking', public: 'fa-solid fa-bus', plane: 'fa-solid fa-plane' }[type] || 'fa-solid fa-shoe-prints');
                const getCategoryIcon = (cat) => ({ food: 'fa-solid fa-utensils', transport: 'fa-solid fa-bus', shopping: 'fa-solid fa-bag-shopping', hotel: 'fa-solid fa-bed', ticket: 'fa-solid fa-ticket', other: 'fa-solid fa-circle' }[cat]);
                const getCategoryColor = (cat) => ({ food: 'bg-orange-400', transport: 'bg-blue-400', shopping: 'bg-pink-400', hotel: 'bg-purple-400', ticket: 'bg-green-500', other: 'bg-gray-400' }[cat]);
                const openMap = (loc) => loc && window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(loc)}`, '_blank');
                const quickSearch = (keyword) => { window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(keyword)}`, '_blank'); };
                const copyText = (text) => { navigator.clipboard.writeText(text).then(() => alert('å·²è¤‡è£½: ' + text)).catch(err => console.error('Copy failed', err)); };
                const saveSettings = () => { localStorage.setItem('gemini_api_key', userApiKey.value); showSettingsModal.value = false; alert('API Key å·²å„²å­˜ï¼'); };
                const openSettings = () => { showSettingsModal.value = true; showImport.value = false; importString.value = ''; };
                const saveToLocal = (key, data) => localStorage.setItem(key, JSON.stringify(data));

                // Export & Import Logic
                const exportData = () => {
                    const data = {
                        itinerary: itineraryData.value,
                        shopping: shoppingList.value,
                        expenses: expenseList.value,
                        hotels: hotels.value // Added Hotels to Export
                    };
                    const jsonStr = JSON.stringify(data);
                    navigator.clipboard.writeText(jsonStr).then(() => alert('è³‡æ–™å·²è¤‡è£½ï¼è«‹å‚³é€åˆ°æ–°æ‰‹æ©Ÿä¸¦ä½¿ç”¨ã€ŒåŒ¯å…¥ã€åŠŸèƒ½ã€‚')).catch(() => alert('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½'));
                };
                
                const importData = () => {
                    try {
                        const data = JSON.parse(importString.value);
                        if(data.itinerary) itineraryData.value = data.itinerary;
                        if(data.shopping) shoppingList.value = data.shopping;
                        if(data.expenses) expenseList.value = data.expenses;
                        if(data.hotels) hotels.value = data.hotels; // Added Hotels to Import
                        
                        saveToLocal('itinerary', itineraryData.value);
                        saveToLocal('shopping', shoppingList.value);
                        saveToLocal('expenses', expenseList.value);
                        saveToLocal('hotels', hotels.value);
                        
                        alert('åŒ¯å…¥æˆåŠŸï¼');
                        showSettingsModal.value = false;
                    } catch(e) {
                        alert('æ ¼å¼éŒ¯èª¤ï¼Œè«‹ç¢ºèªè²¼ä¸Šçš„æ˜¯å®Œæ•´çš„å‚™ä»½ä»£ç¢¼');
                    }
                };

                // AI & Scan
                const askAIGuide = async () => {
                    showAIModal.value = true; isAiLoading.value = true;
                    const text = currentDayItinerary.value.map(i => `${i.time} ${i.name}`).join(', ');
                    const res = await callGemini(`æˆ‘æ˜¯ä¹å·å°éŠã€‚æ—¥æœŸ:${currentDateStr.value}ã€‚è¡Œç¨‹:${text}ã€‚è«‹çµ¦3å€‹çŸ­å»ºè­°(ç¾é£Ÿ/æé†’/å¿ƒæƒ…)ï¼Œç¹ä¸­ï¼Œç†Šæœ¬ç†Šèªæ°£ã€‚`);
                    aiResponse.value = marked.parse(res); isAiLoading.value = false;
                };
                const handleReceiptScan = async (e) => {
                    const file = e.target.files[0]; if (!file) return;
                    isScannerLoading.value = true;
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        const res = await callGeminiVision(`åˆ†ææ”¶æ“šï¼Œå›å‚³JSON:{name, amount(æ•¸å­—), category(food/shopping/transport/hotel/ticket/other), date(YYYY-MM-DD)}`, e.target.result);
                        if(res) { 
                            try {
                                const cleanJson = res.replace(/```json|```/g, '').trim();
                                const data = JSON.parse(cleanJson); 
                                formExpense.value = { ...formExpense.value, ...data, category: data.category || 'other' }; 
                            } catch(e) {
                                console.error("Parse error", e);
                                alert("AI å›å‚³æ ¼å¼ç„¡æ³•è§£æï¼Œè«‹æ‰‹å‹•è¼¸å…¥");
                            }
                        }
                        isScannerLoading.value = false; e.target.value = '';
                    };
                    reader.readAsDataURL(file);
                };

                // Hotel CRUD Logic (Updated for Voucher)
                const openHotelModal = () => { 
                    isEditingHotel.value = false; 
                    formHotel.value = { name: '', checkIn: '', checkOut: '', bookingId: '', platform: 'Agoda', roomType: '', guest: '' }; 
                    showHotelModal.value = true; 
                };
                const editHotel = (hotel, idx) => { 
                    isEditingHotel.value = true; 
                    editingHotelIndex.value = idx; 
                    formHotel.value = { ...hotel }; 
                    showHotelModal.value = true; 
                };
                const saveHotel = () => { 
                    if(!formHotel.value.name) return; 
                    if(isEditingHotel.value) {
                        hotels.value[editingHotelIndex.value] = { ...formHotel.value };
                    } else {
                        hotels.value.push({ ...formHotel.value, id: Date.now() }); 
                    }
                    saveToLocal('hotels', hotels.value); 
                    showHotelModal.value = false; 
                };
                const deleteHotel = (idx) => { 
                    if(confirm('ç¢ºå®šåˆªé™¤é€™å¼µæ†‘è­‰å—ï¼Ÿ')) { 
                        hotels.value.splice(idx, 1); 
                        saveToLocal('hotels', hotels.value); 
                    } 
                };

                // CRUD
                const openAddModal = () => { isEditing.value = false; formItinerary.value = { type: 'sight', transportType: 'car', time: '10:00' }; showItineraryModal.value = true; };
                const editItem = (item) => { isEditing.value = true; formItinerary.value = { ...item }; showItineraryModal.value = true; };
                const saveItinerary = () => {
                    const key = currentDateStr.value; if (!itineraryData.value[key]) itineraryData.value[key] = [];
                    if (isEditing.value) { const idx = itineraryData.value[key].findIndex(i => i.id === formItinerary.value.id); if (idx !== -1) itineraryData.value[key][idx] = { ...formItinerary.value }; } 
                    else itineraryData.value[key].push({ ...formItinerary.value, id: Date.now() });
                    saveToLocal('itinerary', itineraryData.value); showItineraryModal.value = false;
                };
                const confirmDeleteItinerary = () => { if(confirm('åˆªé™¤ï¼Ÿ')) { itineraryData.value[currentDateStr.value] = itineraryData.value[currentDateStr.value].filter(i => i.id !== formItinerary.value.id); saveToLocal('itinerary', itineraryData.value); showItineraryModal.value = false; } };
                
                const openShoppingModal = () => { isEditingShopping.value = false; formShopping.value = { name: '', image: null }; showShoppingModal.value = true; };
                const editShoppingItem = (item, idx) => { isEditingShopping.value = true; editingShoppingIndex.value = idx; formShopping.value = { ...item }; showShoppingModal.value = true; };
                const handleImageUpload = (e) => { const f = e.target.files[0]; if (f) { const r = new FileReader(); r.onload = (e) => formShopping.value.image = e.target.result; r.readAsDataURL(f); } };
                const saveShoppingItem = () => { if(!formShopping.value.name) return; if(isEditingShopping.value) shoppingList.value[editingShoppingIndex.value] = { ...formShopping.value }; else shoppingList.value.push({ ...formShopping.value }); saveToLocal('shopping', shoppingList.value); showShoppingModal.value = false; };
                const deleteShoppingItem = (idx) => { if(confirm('åˆªé™¤ï¼Ÿ')) { shoppingList.value.splice(idx, 1); saveToLocal('shopping', shoppingList.value); } };
                const addPresetItem = (n) => { shoppingList.value.push({ name: n, image: null }); saveToLocal('shopping', shoppingList.value); };

                const openExpenseModal = () => { formExpense.value = { category: 'food', name: '', amount: '', payment: 'cash', date: currentDateStr.value }; showExpenseModal.value = true; };
                const saveExpense = () => { if(!formExpense.value.amount) return; expenseList.value.unshift({ ...formExpense.value }); saveToLocal('expenses', expenseList.value); showExpenseModal.value = false; };
                const deleteExpense = (idx) => { if(confirm('åˆªé™¤ï¼Ÿ')) { expenseList.value.splice(idx, 1); saveToLocal('expenses', expenseList.value); } };

                return {
                    currentTab, tabs, tripDates, selectedDateIndex, currentDateStr, currentDayItinerary, mockWeather, getTransportIcon, openMap,
                    showItineraryModal, isEditing, formItinerary, openAddModal, editItem, saveItinerary, confirmDeleteItinerary,
                    infoMode, phraseCategories, selectedPhraseCat, filteredPhrases, showBigText, bigTextContent, bigTextSub, showBigTextModal,
                    daysUntilTrip, currencyInput, exchangeRate, calculateTWD, hotels,
                    shoppingList, showShoppingModal, formShopping, openShoppingModal, handleImageUpload, saveShoppingItem, deleteShoppingItem, isEditingShopping, editShoppingItem, selectedPresetCategory, presetShoppingItems, addPresetItem,
                    expenseList, showExpenseModal, formExpense, openExpenseModal, saveExpense, deleteExpense, totalExpenses, expensesByCategory, getCategoryIcon, getCategoryColor,
                    askAIGuide, showAIModal, isAiLoading, aiResponse, handleReceiptScan, isScannerLoading, showSettingsModal, userApiKey, saveSettings, openSettings,
                    speak, transInput, transResult, isTranslating, handleTranslation, startListening, isListening, currentListenLang, isSpeechSupported,
                    quickSearch, exportData, importData, showImport, importString,
                    showHotelModal, isEditingHotel, formHotel, openHotelModal, editHotel, saveHotel, deleteHotel, copyText
                };
            }
        }).mount('#app');
    </script>
</body>
</html>

